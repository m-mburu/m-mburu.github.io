---
title: "Loan Prediction Zindi"
author: "mburu"
date: "April 18, 2020"
output:
  html_notebook:
    highlight: pygments
    theme: united
    toc: yes
  html_document:
    highlight: pygments
    theme: united
    toc: yes
  pdf_document:
    toc: yes
  beamer_presentation:
    highlight: pygments
header-includes:
- \usetheme{CambridgeUS}
- \useinnertheme{rounded}
- \usecolortheme{seahorse}
- \usefonttheme{professionalfonts}
- \usepackage{xcolor,soul,hyperref,cite,graphicx,amsmath}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, echo=FALSE}
#setwd("E:/R/Busara Data Analyst task")
options("kableExtra.html.bsTable" = T)
```


```{r}
library(tidyverse)
library(data.table)
library(caret)
library(ggthemes)
```



```{r}

trainperf <- fread("trainperf.csv")
traindemographics <-fread("traindemographics.csv")
testperf <-fread("testperf.csv")
testdemographics <-fread("testdemographics.csv")
SampleSubmission <- fread("SampleSubmission.csv")
```



```{r}
train_data <- merge(traindemographics, trainperf, all.y = T, by = "customerid")
test_data <- merge(testdemographics, testperf, all.y = T, by = "customerid")
```



```{r}


train_data[, .N, by = .(good_bad_flag)] %>%
    .[, perc := round(N/sum(N) * 100, 2)] %>%
    
     ggplot(aes(good_bad_flag, perc, fill =good_bad_flag)) +
     geom_bar(stat = "identity") +
     geom_text(aes(good_bad_flag, perc, label = paste(perc, "%"),
                   vjust = .05, hjust = .5),
               size = 4)+
     theme_hc()+
    labs(title = "Percentage of bad loans")+
     scale_fill_colorblind(name = "")+
    theme(legend.position = "none")



```


```{r}
chars <- c("bank_account_type", "bank_name_clients", 
           "bank_branch_clients", "employment_status_clients",
           "level_of_education_clients")

train_data[, (chars) := lapply(.SD, function(x) ifelse(x == "" | x == " ", NA, x)), .SDcols = chars]
```


```{r}

naVals <- colSums(is.na(train_data))/nrow(train_data) * 100 

withNa <- naVals[naVals>0]
nms_na <- names(withNa)
missing_perc <- data.table(variables = nms_na, perc = withNa) 


```


##

```{r}
ggplot(missing_perc, aes( reorder(variables, perc), perc))+
    geom_bar(stat = "identity") +
    theme_fivethirtyeight()+
    coord_flip()
```




```{r}
# try out to add a missing coonvert 
train_data[, (chars) := lapply(.SD, fct_explicit_na, na_level = "missing"), .SDcols = chars]
train2 <- train_data[, .(good_bad_flag, termdays, 
                         loannumber, loanamount, 
                         totaldue, bank_account_type, bank_name_clients, employment_status_clients, level_of_education_clients)]



cv_fold <- createFolds(train2$good_bad_flag, k = 5)

myControl <- trainControl(
  method = "cv", 
  number = 5,
  summaryFunction = twoClassSummary,
  savePredictions = "all",
  classProbs = TRUE,
  verboseIter = FALSE,
  index = cv_fold,
  allowParallel = TRUE
  
)
svm_tune <-  expand.grid(
    C =c(1000,1500, 2000),
    sigma = seq(0, 1, length.out = 5))
    
svm_model <- train(
  good_bad_flag ~.,
  data = train2,
   metric="ROC",
  method = "svmRadial",
  trControl = myControl,
  tuneGrid = svm_tune,
  verbose = FALSE
)

```

