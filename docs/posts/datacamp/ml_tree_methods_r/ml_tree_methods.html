<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mburu">
<meta name="dcterms.date" content="2020-04-04">

<title>Mburu Blog - ML with tree based models in r</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../../style.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Mburu Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/m-mburu"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/mmburu_w"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">ML with tree based models in r</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Mburu </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 4, 2020</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="build-a-classification-tree" class="level2">
<h2 class="anchored" data-anchor-id="build-a-classification-tree">Build a classification tree</h2>
<p>Let’s get started and build our first classification tree. A classification tree is a decision tree that performs a classification (vs regression) task. You will train a decision tree model to understand which loan applications are at higher risk of default using a subset of the German Credit Dataset. The response variable, called “default”, indicates whether the loan went into a default or not, which means this is a binary classification problem (there are just two classes). You will use the rpart package to fit the decision tree and the rpart.plot package to visualize the tree.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>credit <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"credit.csv"</span>, <span class="at">stringsAsFactors =</span> <span class="cn">TRUE</span>) </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>credit[, default <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(default)]</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>creditsub <span class="ot">&lt;-</span> credit[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(credit), <span class="dv">522</span>),]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(creditsub)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Classes 'data.table' and 'data.frame':  522 obs. of  17 variables:
 $ checking_balance    : Factor w/ 4 levels "1 - 200 DM","&lt; 0 DM",..: 2 4 4 4 4 1 1 2 4 1 ...
 $ months_loan_duration: int  12 21 24 24 18 48 36 18 18 24 ...
 $ credit_history      : Factor w/ 5 levels "critical","good",..: 2 1 2 2 1 4 2 2 4 2 ...
 $ purpose             : Factor w/ 6 levels "business","car",..: 4 2 5 2 2 4 4 5 1 2 ...
 $ amount              : int  684 3275 1552 9277 1028 6224 12612 1345 2169 1246 ...
 $ savings_balance     : Factor w/ 5 levels "100 - 500 DM",..: 3 3 3 5 3 3 1 3 3 3 ...
 $ employment_duration : Factor w/ 5 levels "1 - 4 years",..: 1 4 2 1 1 4 1 1 1 3 ...
 $ percent_of_income   : int  4 1 3 2 4 4 1 4 4 4 ...
 $ years_at_residence  : int  4 4 1 4 3 4 4 3 2 2 ...
 $ age                 : int  40 36 32 48 36 50 47 26 28 23 ...
 $ other_credit        : Factor w/ 3 levels "bank","none",..: 2 2 1 2 2 2 2 1 2 3 ...
 $ housing             : Factor w/ 3 levels "other","own",..: 3 2 2 1 2 1 1 2 2 2 ...
 $ existing_loans_count: int  1 1 1 1 2 1 1 1 1 1 ...
 $ job                 : Factor w/ 4 levels "management","skilled",..: 4 1 2 2 2 2 2 2 2 4 ...
 $ dependents          : int  2 1 2 1 1 1 2 1 1 1 ...
 $ phone               : Factor w/ 2 levels "no","yes": 1 2 1 2 1 1 2 1 2 1 ...
 $ default             : Factor w/ 2 levels "no","yes": 2 1 1 1 1 2 2 2 2 2 ...
 - attr(*, ".internal.selfref")=&lt;externalptr&gt; </code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the model</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>credit_model <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> default <span class="sc">~</span> ., </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> creditsub, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the results</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(<span class="at">x =</span> credit_model, <span class="at">yesno =</span> <span class="dv">2</span>, <span class="at">type =</span> <span class="dv">0</span>, <span class="at">extra =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ml_tree_methods_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="864"></p>
</div>
</div>
</section>
<section id="traintest-split" class="level2">
<h2 class="anchored" data-anchor-id="traintest-split">Train/test split</h2>
<p>For this exercise, you’ll randomly split the German Credit Dataset into two pieces: a training set (80%) called credit_train and a test set (20%) that we will call credit_test. We’ll use these two sets throughout the chapter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Total number of rows in the credit data frame</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(credit)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of rows for the training set (80% of the dataset)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>n_train <span class="ot">&lt;-</span> <span class="fu">round</span>(.<span class="dv">8</span> <span class="sc">*</span> n) </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a vector of indices which is an 80% random sample</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n, n_train)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset the credit data frame to training indices only</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>credit_train <span class="ot">&lt;-</span> credit[train_indices, ]  </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Exclude the training indices to create the test set</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>credit_test <span class="ot">&lt;-</span> credit[<span class="sc">-</span>train_indices, ]  </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the model (to predict 'default')</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>credit_model <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> default <span class="sc">~</span>., </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> credit_train, </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                      <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the model output                      </span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(credit_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 800 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

  1) root 800 230 no (0.7125000 0.2875000)  
    2) checking_balance=&gt; 200 DM,unknown 365  48 no (0.8684932 0.1315068) *
    3) checking_balance=1 - 200 DM,&lt; 0 DM 435 182 no (0.5816092 0.4183908)  
      6) months_loan_duration&lt; 22.5 259  85 no (0.6718147 0.3281853)  
       12) credit_history=critical,good,poor 235  68 no (0.7106383 0.2893617)  
         24) months_loan_duration&lt; 11.5 70  11 no (0.8428571 0.1571429) *
         25) months_loan_duration&gt;=11.5 165  57 no (0.6545455 0.3454545)  
           50) amount&gt;=1282 112  30 no (0.7321429 0.2678571) *
           51) amount&lt; 1282 53  26 yes (0.4905660 0.5094340)  
            102) purpose=business,education,furniture/appliances 34  12 no (0.6470588 0.3529412) *
            103) purpose=car,renovations 19   4 yes (0.2105263 0.7894737) *
       13) credit_history=perfect,very good 24   7 yes (0.2916667 0.7083333) *
      7) months_loan_duration&gt;=22.5 176  79 yes (0.4488636 0.5511364)  
       14) savings_balance=&gt; 1000 DM,unknown 29   7 no (0.7586207 0.2413793) *
       15) savings_balance=100 - 500 DM,500 - 1000 DM,&lt; 100 DM 147  57 yes (0.3877551 0.6122449)  
         30) months_loan_duration&lt; 47.5 119  54 yes (0.4537815 0.5462185)  
           60) amount&gt;=2313.5 93  45 no (0.5161290 0.4838710)  
            120) amount&lt; 3026 19   5 no (0.7368421 0.2631579) *
            121) amount&gt;=3026 74  34 yes (0.4594595 0.5405405)  
              242) percent_of_income&lt; 2.5 38  15 no (0.6052632 0.3947368)  
                484) purpose=business,car,education 23   6 no (0.7391304 0.2608696) *
                485) purpose=car0,furniture/appliances,renovations 15   6 yes (0.4000000 0.6000000) *
              243) percent_of_income&gt;=2.5 36  11 yes (0.3055556 0.6944444) *
           61) amount&lt; 2313.5 26   6 yes (0.2307692 0.7692308) *
         31) months_loan_duration&gt;=47.5 28   3 yes (0.1071429 0.8928571) *</code></pre>
</div>
</div>
</section>
<section id="compute-confusion-matrix" class="level2">
<h2 class="anchored" data-anchor-id="compute-confusion-matrix">Compute confusion matrix</h2>
<p>As discussed in the previous video, there are a number of different metrics by which you can measure the performance of a classification model. In this exercise, we will evaluate the performance of the model using test set classification error. A confusion matrix is a convenient way to examine the per-class error rates for all classes at once. The confusionMatrix() function from the caret package prints both the confusion matrix and a number of other useful classification metrics such as “Accuracy” (fraction of correctly classified instances). The caret package has been loaded for you.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predicted classes using the model object</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>class_prediction <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_model,  </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">newdata =</span> credit_test,   </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type =</span> <span class="st">"class"</span>)  </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the confusion matrix for the test set</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>class_prediction <span class="ot">&lt;-</span> <span class="fu">factor</span>(class_prediction, <span class="at">levels =</span> <span class="fu">levels</span>(credit_test<span class="sc">$</span>default) )</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(<span class="at">data =</span> class_prediction,       </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">reference =</span> credit_test<span class="sc">$</span>default, <span class="at">positive =</span> <span class="st">"yes"</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction  no yes
       no  117  44
       yes  13  26
                                          
               Accuracy : 0.715           
                 95% CI : (0.6471, 0.7764)
    No Information Rate : 0.65            
    P-Value [Acc &gt; NIR] : 0.03046         
                                          
                  Kappa : 0.3023          
                                          
 Mcnemar's Test P-Value : 7.08e-05        
                                          
            Sensitivity : 0.3714          
            Specificity : 0.9000          
         Pos Pred Value : 0.6667          
         Neg Pred Value : 0.7267          
             Prevalence : 0.3500          
         Detection Rate : 0.1300          
   Detection Prevalence : 0.1950          
      Balanced Accuracy : 0.6357          
                                          
       'Positive' Class : yes             
                                          </code></pre>
</div>
</div>
</section>
<section id="compare-models-with-a-different-splitting-criterion" class="level2">
<h2 class="anchored" data-anchor-id="compare-models-with-a-different-splitting-criterion">Compare models with a different splitting criterion</h2>
<p>Train two models that use a different splitting criterion and use the validation set to choose a “best” model from this group. To do this you’ll use the parms argument of the rpart() function. This argument takes a named list that contains values of different parameters you can use to change how the model is trained. Set the parameter split to control the splitting criterion.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train a gini-based model</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>credit_model1 <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> default <span class="sc">~</span> ., </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> credit_train, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">method =</span> <span class="st">"class"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">parms =</span> <span class="fu">list</span>(<span class="at">split =</span> <span class="st">"gini"</span>))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Train an information-based model</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>credit_model2 <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> default <span class="sc">~</span> ., </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> credit_train, </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">method =</span> <span class="st">"class"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">parms =</span> <span class="fu">list</span>(<span class="at">split =</span> <span class="st">"information"</span>))</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions on the validation set using the gini model</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>pred1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_model1, </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">newdata =</span> credit_test,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="st">"class"</span>)    </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions on the validation set using the information model</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>pred2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_model2, </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">newdata =</span> credit_test,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="st">"class"</span>) </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>dt_preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_model2, </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>             <span class="at">newdata =</span> credit_test,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="st">"prob"</span>) </span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare classification error</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Metrics)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ce</span>(<span class="at">actual =</span> credit_test<span class="sc">$</span>default, </span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>   <span class="at">predicted =</span> pred1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.285</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ce</span>(<span class="at">actual =</span> credit_test<span class="sc">$</span>default, </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">predicted =</span> pred2)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.285</code></pre>
</div>
</div>
</section>
<section id="the-response-is-final_grade-numeric-from-0-to-20-output-target." class="level2">
<h2 class="anchored" data-anchor-id="the-response-is-final_grade-numeric-from-0-to-20-output-target.">The response is final_grade (numeric: from 0 to 20, output target).</h2>
<p>After initial exploration, split the data into training, validation, and test sets. In this chapter, we will introduce the idea of a validation set, which can be used to select a “best” model from a set of competing models. In Chapter 1, we demonstrated a simple way to split the data into two pieces using the sample() function. In this exercise, we will take a slightly different approach to splitting the data that allows us to split the data into more than two parts (here, we want three: train, validation, test). We still use the sample() function, but instead of sampling the indices themselves, we will assign each row to either the training, validation or test sets according to a probability distribution. The dataset grade is already in your workspace.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>grade <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"grade.csv"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the data</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(grade)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   395 obs. of  8 variables:
 $ final_grade: num  3 3 5 7.5 5 7.5 5.5 3 9.5 7.5 ...
 $ age        : int  18 17 15 15 16 16 16 17 15 15 ...
 $ address    : chr  "U" "U" "U" "U" ...
 $ studytime  : int  2 2 2 3 2 2 2 2 2 2 ...
 $ schoolsup  : chr  "yes" "no" "yes" "no" ...
 $ famsup     : chr  "no" "yes" "no" "yes" ...
 $ paid       : chr  "no" "no" "yes" "yes" ...
 $ absences   : int  6 4 10 2 4 10 0 6 0 0 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed and create assignment</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>assignment <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">size =</span> <span class="fu">nrow</span>(grade), <span class="at">prob =</span> <span class="fu">c</span>(.<span class="dv">7</span>, .<span class="dv">15</span>, .<span class="dv">15</span>), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a train, validation and tests from the original data frame </span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>grade_train <span class="ot">&lt;-</span> grade[assignment <span class="sc">==</span> <span class="dv">1</span>, ]    <span class="co"># subset grade to training indices only</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>grade_valid <span class="ot">&lt;-</span> grade[assignment <span class="sc">==</span> <span class="dv">2</span>, ]  <span class="co"># subset grade to validation indices only</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>grade_test <span class="ot">&lt;-</span> grade[assignment <span class="sc">==</span> <span class="dv">3</span>, ]   <span class="co"># subset grade to test indices only</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="train-a-regression-tree-model" class="level2">
<h2 class="anchored" data-anchor-id="train-a-regression-tree-model">Train a regression tree model</h2>
<p>In this exercise, we will use the grade_train dataset to fit a regression tree using rpart() and visualize it using rpart.plot(). A regression tree plot looks identical to a classification tree plot, with the exception that there will be numeric values in the leaf nodes instead of predicted classes. This is very similar to what we did previously in Chapter 1. When fitting a classification tree, we use method = “class”, however, when fitting a regression tree, we need to set method = “anova”. By default, the rpart() function will make an intelligent guess as to what the method value should be based on the data type of your response column, but it’s recommened that you explictly set the method for reproducibility reasons (since the auto-guesser may change in the future). The grade_train training set is loaded into the workspace.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the model</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>grade_model <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> final_grade <span class="sc">~</span> ., </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> grade_train, </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">method =</span> <span class="st">"anova"</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the model output                      </span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(grade_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 282 

node), split, n, deviance, yval
      * denotes terminal node

 1) root 282 1519.49700 5.271277  
   2) absences&lt; 0.5 82  884.18600 4.323171  
     4) paid=no 50  565.50500 3.430000  
       8) famsup=yes 22  226.36360 2.272727 *
       9) famsup=no 28  286.52680 4.339286 *
     5) paid=yes 32  216.46880 5.718750  
      10) age&gt;=17.5 10   82.90000 4.100000 *
      11) age&lt; 17.5 22   95.45455 6.454545 *
   3) absences&gt;=0.5 200  531.38000 5.660000  
     6) absences&gt;=13.5 42  111.61900 4.904762 *
     7) absences&lt; 13.5 158  389.43670 5.860759  
      14) schoolsup=yes 23   50.21739 4.847826 *
      15) schoolsup=no 135  311.60000 6.033333  
        30) studytime&lt; 3.5 127  276.30710 5.940945 *
        31) studytime&gt;=3.5 8   17.00000 7.500000 *</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the tree model</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(<span class="at">x =</span> grade_model, <span class="at">yesno =</span> <span class="dv">2</span>, <span class="at">type =</span> <span class="dv">0</span>, <span class="at">extra =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ml_tree_methods_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
<section id="evaluate-a-regression-tree-model" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-a-regression-tree-model">Evaluate a regression tree model</h2>
<p>Predict the final grade for all students in the test set. The grade is on a 0-20 scale. Evaluate the model based on test set RMSE (Root Mean Squared Error). RMSE tells us approximately how far away our predictions are from the true values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions on a test set</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> grade_model,   <span class="co"># model object </span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">newdata =</span> grade_test)  <span class="co"># test dataset</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the RMSE</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rmse</span>(<span class="at">actual =</span> grade_test<span class="sc">$</span>final_grade, </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">predicted =</span> pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.278249</code></pre>
</div>
</div>
</section>
<section id="tuning-the-model" class="level2">
<h2 class="anchored" data-anchor-id="tuning-the-model">Tuning the model</h2>
<p>Tune (or “trim”) the model using the prune() function by finding the best “CP” value (CP stands for “Complexity Parameter”).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the "CP Table"</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotcp</span>(grade_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ml_tree_methods_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="768"></p>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the "CP Table"</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(grade_model<span class="sc">$</span>cptable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          CP nsplit rel error    xerror       xstd
1 0.06839852      0 1.0000000 1.0066743 0.09169976
2 0.06726713      1 0.9316015 1.0185398 0.08663026
3 0.03462630      2 0.8643344 0.8923588 0.07351895
4 0.02508343      3 0.8297080 0.9046335 0.08045100
5 0.01995676      4 0.8046246 0.8920489 0.08153881
6 0.01817661      5 0.7846679 0.9042142 0.08283114
7 0.01203879      6 0.7664912 0.8833557 0.07945742
8 0.01000000      7 0.7544525 0.8987112 0.08200148</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve optimal cp value based on cross-validated error</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>opt_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(grade_model<span class="sc">$</span>cptable[, <span class="st">"xerror"</span>])</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>cp_opt <span class="ot">&lt;-</span> grade_model<span class="sc">$</span>cptable[opt_index, <span class="st">"CP"</span>]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Prune the model (to optimized cp value)</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>grade_model_opt <span class="ot">&lt;-</span> <span class="fu">prune</span>(<span class="at">tree =</span> grade_model, </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cp =</span> cp_opt)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                          </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the optimized model</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(<span class="at">x =</span> grade_model_opt, <span class="at">yesno =</span> <span class="dv">2</span>, <span class="at">type =</span> <span class="dv">0</span>, <span class="at">extra =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ml_tree_methods_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
<section id="generate-a-grid-of-hyperparameter-values" class="level2">
<h2 class="anchored" data-anchor-id="generate-a-grid-of-hyperparameter-values">Generate a grid of hyperparameter values</h2>
<p>Use expand.grid() to generate a grid of maxdepth and minsplit values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Establish a list of possible values for minsplit and maxdepth</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>minsplit <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>maxdepth <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">6</span>, <span class="dv">1</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data frame containing all combinations </span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>hyper_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">minsplit =</span> minsplit, <span class="at">maxdepth =</span> maxdepth)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check out the grid</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hyper_grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  minsplit maxdepth
1        1        1
2        2        1
3        3        1
4        4        1
5        1        2
6        2        2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the number of grid combinations</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(hyper_grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24</code></pre>
</div>
</div>
</section>
<section id="generate-a-grid-of-models" class="level2">
<h2 class="anchored" data-anchor-id="generate-a-grid-of-models">Generate a grid of models</h2>
<p>In this exercise, we will write a simple loop to train a “grid” of models and store the models in a list called grade_models. R users who are familiar with the apply functions in R could think about how this loop could be easily converted into a function applied to a list as an extra-credit thought experiment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of potential models in the grid</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>num_models <span class="ot">&lt;-</span> <span class="fu">nrow</span>(hyper_grid)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list to store models</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>grade_models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Write a loop over the rows of hyper_grid to train the grid of models</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_models) {</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get minsplit, maxdepth values at row i</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    minsplit <span class="ot">&lt;-</span> hyper_grid<span class="sc">$</span>minsplit[i]</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    maxdepth <span class="ot">&lt;-</span> hyper_grid<span class="sc">$</span>maxdepth[i]</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train a model and store in the list</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    grade_models[[i]] <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> final_grade <span class="sc">~</span> ., </span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> grade_train, </span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>                               <span class="at">method =</span> <span class="st">"anova"</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>                               <span class="at">minsplit =</span> minsplit,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>                               <span class="at">maxdepth =</span> maxdepth)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Evaluate the grid Earlier in the chapter we split the dataset into three parts: training, validation and test.</p>
<p>A dataset that is not used in training is sometimes referred to as a “holdout” set. A holdout set is used to estimate model performance and although both validation and test sets are considered to be holdout data, there is a key difference:</p>
<p>Just like a test set, a validation set is used to evaluate the performance of a model. The difference is that a validation set is specifically used to compare the performance of a group of models with the goal of choosing a “best model” from the group. All the models in a group are evaluated on the same validation set and the model with the best performance is considered to be the winner. Once you have the best model, a final estimate of performance is computed on the test set. A test set should only ever be used to estimate model performance and should not be used in model selection. Typically if you use a test set more than once, you are probably doing something wrong.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of potential models in the grid</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>num_models <span class="ot">&lt;-</span> <span class="fu">length</span>(grade_models)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty vector to store RMSE values</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>rmse_values <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Write a loop over the models to compute validation RMSE</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_models) {</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Retrieve the i^th model from the list</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> grade_models[[i]]</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate predictions on grade_valid </span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> model,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">newdata =</span> grade_valid)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute validation RMSE and add to the </span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    rmse_values[i] <span class="ot">&lt;-</span> <span class="fu">rmse</span>(<span class="at">actual =</span> grade_valid<span class="sc">$</span>final_grade, </span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>                           <span class="at">predicted =</span> pred)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the model with smallest validation set RMSE</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>best_model <span class="ot">&lt;-</span> grade_models[[<span class="fu">which.min</span>(rmse_values)]]</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the model paramters of the best model</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>best_model<span class="sc">$</span>control</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$minsplit
[1] 2

$minbucket
[1] 1

$cp
[1] 0.01

$maxcompete
[1] 4

$maxsurrogate
[1] 5

$usesurrogate
[1] 2

$surrogatestyle
[1] 0

$maxdepth
[1] 1

$xval
[1] 10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute test set RMSE on best_model</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> best_model,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">newdata =</span> grade_test)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rmse</span>(<span class="at">actual =</span> grade_test<span class="sc">$</span>final_grade, </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">predicted =</span> pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.124109</code></pre>
</div>
</div>
</section>
<section id="train-a-bagged-tree-model" class="level2">
<h2 class="anchored" data-anchor-id="train-a-bagged-tree-model">Train a bagged tree model</h2>
<p>Let’s start by training a bagged tree model. You’ll be using the bagging() function from the ipred package. The number of bagged trees can be specified using the nbagg parameter, but here we will use the default (25). If we want to estimate the model’s accuracy using the “out-of-bag” (OOB) samples, we can set the the coob parameter to TRUE. The OOB samples are the training obsevations that were not selected into the bootstrapped sample (used in training). Since these observations were not used in training, we can use them instead to evaluate the accuracy of the model (done automatically inside the bagging() function).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ipred)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Bagging is a randomized model, so let's set a seed (123) for reproducibility</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Train a bagged model</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>credit_model <span class="ot">&lt;-</span> <span class="fu">bagging</span>(<span class="at">formula =</span> default <span class="sc">~</span> ., </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> credit_train,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">coob =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the model</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(credit_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Bagging classification trees with 25 bootstrap replications 

Call: bagging.data.frame(formula = default ~ ., data = credit_train, 
    coob = TRUE)

Out-of-bag estimate of misclassification error:  0.2537 </code></pre>
</div>
</div>
</section>
<section id="prediction-and-confusion-matrix" class="level2">
<h2 class="anchored" data-anchor-id="prediction-and-confusion-matrix">Prediction and confusion matrix</h2>
<p>As you saw in the video, a confusion matrix is a very useful tool for examining all possible outcomes of your predictions (true positive, true negative, false positive, false negative). In this exercise, you will predict those who will default using bagged trees. You will also create the confusion matrix using the confusionMatrix() function from the caret package. It’s always good to take a look at the output using the print() function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predicted classes using the model object</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>class_prediction <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_model,    </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">newdata =</span> credit_test,  </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">type =</span> <span class="st">"class"</span>)  <span class="co"># return classification labels</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the predicted classes</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(class_prediction)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] no  no  no  no  yes no  no  no  no  no  no  no  no  yes no  no  no  no 
 [19] no  no  yes no  no  no  no  no  yes no  no  no  no  no  no  no  no  no 
 [37] yes yes no  yes no  yes no  no  no  no  no  no  no  yes no  yes no  yes
 [55] yes no  yes no  yes no  no  yes no  no  yes yes no  yes no  no  no  yes
 [73] yes no  no  no  no  no  no  yes no  no  no  no  yes no  no  yes no  no 
 [91] no  no  no  yes yes no  no  no  no  no  no  yes no  no  yes no  no  no 
[109] no  no  no  no  no  no  no  no  no  no  no  no  yes no  yes no  no  yes
[127] yes no  yes no  no  no  no  no  yes no  yes yes no  no  no  no  yes no 
[145] no  no  yes no  no  no  no  yes no  no  no  no  no  no  no  yes no  no 
[163] yes no  yes no  no  no  no  no  no  no  no  no  no  no  no  no  no  no 
[181] no  no  yes yes yes no  yes no  no  no  no  no  yes no  no  no  yes no 
[199] no  yes
Levels: no yes</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the confusion matrix for the test set</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(<span class="at">data =</span>  class_prediction,     </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">reference =</span>  credit_test<span class="sc">$</span>default, <span class="at">positive =</span> <span class="st">"yes"</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction  no yes
       no  119  33
       yes  11  37
                                          
               Accuracy : 0.78            
                 95% CI : (0.7161, 0.8354)
    No Information Rate : 0.65            
    P-Value [Acc &gt; NIR] : 4.557e-05       
                                          
                  Kappa : 0.4787          
                                          
 Mcnemar's Test P-Value : 0.001546        
                                          
            Sensitivity : 0.5286          
            Specificity : 0.9154          
         Pos Pred Value : 0.7708          
         Neg Pred Value : 0.7829          
             Prevalence : 0.3500          
         Detection Rate : 0.1850          
   Detection Prevalence : 0.2400          
      Balanced Accuracy : 0.7220          
                                          
       'Positive' Class : yes             
                                          </code></pre>
</div>
</div>
</section>
<section id="predict-on-a-test-set-and-compute-auc" class="level2">
<h2 class="anchored" data-anchor-id="predict-on-a-test-set-and-compute-auc">Predict on a test set and compute AUC</h2>
<p>In binary classification problems, we can predict numeric values instead of class labels. In fact, class labels are created only after you use the model to predict a raw, numeric, predicted value for a test point. The predicted label is generated by applying a threshold to the predicted value, such that all tests points with predicted value greater than that threshold get a predicted label of “1” and, points below that threshold get a predicted label of “0”. In this exercise, generate predicted values (rather than class labels) on the test set and evaluate performance based on AUC (Area Under the ROC Curve). The AUC is a common metric for evaluating the discriminatory ability of a binary classification model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions on the test set</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_model,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">newdata =</span> credit_test,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># `pred` is a matrix</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "matrix" "array" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the pred format</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       no  yes
[1,] 0.92 0.08
[2,] 0.92 0.08
[3,] 1.00 0.00
[4,] 1.00 0.00
[5,] 0.16 0.84
[6,] 0.84 0.16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the AUC (`actual` must be a binary (or 1/0 numeric) vector)</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>credit_ipred_model_test_auc <span class="ot">&lt;-</span> <span class="fu">auc</span>(<span class="at">actual =</span> <span class="fu">ifelse</span>(credit_test<span class="sc">$</span>default <span class="sc">==</span> <span class="st">"yes"</span>, <span class="dv">1</span>, <span class="dv">0</span>), </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">predicted =</span> pred[,<span class="st">"yes"</span>])  </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>credit_ipred_model_test_auc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8084066</code></pre>
</div>
</div>
</section>
<section id="cross-validate-a-bagged-tree-model-in-caret" class="level2">
<h2 class="anchored" data-anchor-id="cross-validate-a-bagged-tree-model-in-caret">Cross-validate a bagged tree model in caret</h2>
<p>Use caret::train() with the “treebag” method to train a model and evaluate the model using cross-validated AUC. The caret package allows the user to easily cross-validate any model across any relevant performance metric. In this case, we will use 5-fold cross validation and evaluate cross-validated AUC (Area Under the ROC Curve).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the training configuration</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>ctrl_bag <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>,     <span class="co"># Cross-validation</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">number =</span> <span class="dv">5</span>,      <span class="co"># 5 folds</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">classProbs =</span> <span class="cn">TRUE</span>,                  <span class="co"># For AUC</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">summaryFunction =</span> twoClassSummary)  <span class="co"># For AUC</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross validate the credit model using "treebag" method; </span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Track AUC (Area under the ROC curve)</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>credit_caret_model <span class="ot">&lt;-</span> <span class="fu">train</span>(default <span class="sc">~</span> .,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">data =</span> credit_train, </span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>                            <span class="at">method =</span> <span class="st">"treebag"</span>,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>                            <span class="at">metric =</span> <span class="st">"ROC"</span>,</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trControl =</span> ctrl_bag)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the model object</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(credit_caret_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bagged CART 

800 samples
 16 predictor
  2 classes: 'no', 'yes' 

No pre-processing
Resampling: Cross-Validated (5 fold) 
Summary of sample sizes: 640, 640, 640, 640, 640 
Resampling results:

  ROC       Sens       Spec     
  0.744508  0.8736842  0.4173913</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the contents of the model list </span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(credit_caret_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "method"       "modelInfo"    "modelType"    "results"      "pred"        
 [6] "bestTune"     "call"         "dots"         "metric"       "control"     
[11] "finalModel"   "preProcess"   "trainingData" "ptype"        "resample"    
[16] "resampledCM"  "perfNames"    "maximize"     "yLimits"      "times"       
[21] "levels"       "terms"        "coefnames"    "contrasts"    "xlevels"     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the CV AUC</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>credit_caret_model<span class="sc">$</span>results[,<span class="st">"ROC"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.744508</code></pre>
</div>
</div>
</section>
<section id="generate-predictions-from-the-caret-model" class="level2">
<h2 class="anchored" data-anchor-id="generate-predictions-from-the-caret-model">Generate predictions from the caret model</h2>
<p>Generate predictions on a test set for the caret model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions on the test set</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>bag_preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_caret_model, </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">newdata =</span> credit_test,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the AUC (`actual` must be a binary (or 1/0 numeric) vector)</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>credit_caret_model_test_auc <span class="ot">&lt;-</span> <span class="fu">auc</span>(<span class="at">actual =</span> <span class="fu">ifelse</span>(credit_test<span class="sc">$</span>default <span class="sc">==</span> <span class="st">"yes"</span>, <span class="dv">1</span>, <span class="dv">0</span>), </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">predicted =</span> pred[,<span class="st">"yes"</span>])</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>credit_caret_model_test_auc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8084066</code></pre>
</div>
</div>
</section>
<section id="compare-test-set-performance-to-cv-performance" class="level2">
<h2 class="anchored" data-anchor-id="compare-test-set-performance-to-cv-performance">Compare test set performance to CV performance</h2>
<p>In this excercise, you will print test set AUC estimates that you computed in previous exercises. These two methods use the same code underneath, so the estimates should be very similar.</p>
<p>The credit_ipred_model_test_auc object stores the test set AUC from the model trained using the ipred::bagging() function. The credit_caret_model_test_auc object stores the test set AUC from the model trained using the caret::train() function with method = “treebag”. Lastly, we will print the 5-fold cross-validated estimate of AUC that is stored within the credit_caret_model object. This number will be a more accurate estimate of the true model performance since we have averaged the performance over five models instead of just one.</p>
<p>On small datasets like this one, the difference between test set model performance estimates and cross-validated model performance estimates will tend to be more pronounced. When using small data, it’s recommended to use cross-validated estimates of performance because they are more stable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print ipred::bagging test set AUC estimate</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(credit_ipred_model_test_auc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8084066</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print caret "treebag" test set AUC estimate</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(credit_caret_model_test_auc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8084066</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to caret 5-fold cross-validated AUC</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>credit_caret_model<span class="sc">$</span>results[, <span class="st">"ROC"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.744508</code></pre>
</div>
</div>
</section>
<section id="train-a-random-forest-model" class="level2">
<h2 class="anchored" data-anchor-id="train-a-random-forest-model">Train a Random Forest model</h2>
<p>Here you will use the randomForest() function from the randomForest package to train a Random Forest classifier to predict loan default.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Train a Random Forest</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>credit_model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(<span class="at">formula =</span> default <span class="sc">~</span> ., </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> credit_train)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                             </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the model output                             </span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(credit_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(formula = default ~ ., data = credit_train) 
               Type of random forest: classification
                     Number of trees: 500
No. of variables tried at each split: 4

        OOB estimate of  error rate: 24.12%
Confusion matrix:
     no yes class.error
no  521  49  0.08596491
yes 144  86  0.62608696</code></pre>
</div>
</div>
</section>
<section id="evaluate-out-of-bag-error" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-out-of-bag-error">Evaluate out-of-bag error</h2>
<p>Here you will plot the OOB error as a function of the number of trees trained, and extract the final OOB error of the Random Forest model from the trained model object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Grab OOB error matrix &amp; take a look</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>err <span class="ot">&lt;-</span> credit_model<span class="sc">$</span>err.rate</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(err)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           OOB        no       yes
[1,] 0.3310105 0.2400000 0.5402299
[2,] 0.3519313 0.2283951 0.6338028
[3,] 0.3164129 0.1912833 0.6067416
[4,] 0.3130564 0.1886792 0.6142132
[5,] 0.3039890 0.1776062 0.6172249
[6,] 0.2957560 0.1713222 0.6036866</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at final OOB error rate (last row in err matrix)</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>oob_err <span class="ot">&lt;-</span> err[<span class="fu">nrow</span>(err), <span class="st">"OOB"</span>]</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(oob_err)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    OOB 
0.24125 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the model trained in the previous exercise</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(credit_model)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a legend since it doesn't have one by default</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x =</span> <span class="st">"right"</span>, </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">colnames</span>(err),</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(err))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ml_tree_methods_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="evaluate-model-performance-on-a-test-set" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-model-performance-on-a-test-set">Evaluate model performance on a test set</h2>
<p>Use the caret::confusionMatrix() function to compute test set accuracy and generate a confusion matrix. Compare the test set accuracy to the OOB accuracy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predicted classes using the model object</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>class_prediction <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_model,   <span class="co"># model object </span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">newdata =</span> credit_test,  <span class="co"># test dataset</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">type =</span> <span class="st">"class"</span>) <span class="co"># return classification labels</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the confusion matrix for the test set</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>cm <span class="ot">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="at">data =</span> class_prediction,       <span class="co"># predicted classes</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">reference =</span> credit_test<span class="sc">$</span>default, <span class="at">positive =</span> <span class="st">"yes"</span>)  <span class="co"># actual classes</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction  no yes
       no  121  39
       yes   9  31
                                          
               Accuracy : 0.76            
                 95% CI : (0.6947, 0.8174)
    No Information Rate : 0.65            
    P-Value [Acc &gt; NIR] : 0.0005292       
                                          
                  Kappa : 0.4146          
                                          
 Mcnemar's Test P-Value : 2.842e-05       
                                          
            Sensitivity : 0.4429          
            Specificity : 0.9308          
         Pos Pred Value : 0.7750          
         Neg Pred Value : 0.7562          
             Prevalence : 0.3500          
         Detection Rate : 0.1550          
   Detection Prevalence : 0.2000          
      Balanced Accuracy : 0.6868          
                                          
       'Positive' Class : yes             
                                          </code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare test set accuracy to OOB accuracy</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">paste0</span>(<span class="st">"Test Accuracy: "</span>, cm<span class="sc">$</span>overall[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Test Accuracy: 0.76"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paste0</span>(<span class="st">"OOB Accuracy: "</span>, <span class="dv">1</span> <span class="sc">-</span> oob_err)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "OOB Accuracy: 0.75875"</code></pre>
</div>
</div>
</section>
<section id="advantage-of-oob-error" class="level2">
<h2 class="anchored" data-anchor-id="advantage-of-oob-error">Advantage of OOB error</h2>
<p>What is the main advantage of using OOB error instead of validation or test error? - If you evaluate your model using OOB error, then you don’t need to create a separate test set</p>
</section>
<section id="evaluate-test-set-auc" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-test-set-auc">Evaluate test set AUC</h2>
<p>In Chapter 3, we learned about the AUC metric for evaluating binary classification models. In this exercise, you will compute test set AUC for the Random Forest model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions on the test set</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_model,</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">newdata =</span> credit_test,</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="co"># `pred` is a matrix</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "matrix" "array"  "votes" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the pred format</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     no   yes
1 0.910 0.090
2 0.892 0.108
3 0.992 0.008
4 0.952 0.048
5 0.224 0.776
6 0.846 0.154</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the AUC (`actual` must be a binary 1/0 numeric vector)</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">auc</span>(<span class="at">actual =</span> <span class="fu">ifelse</span>(credit_test<span class="sc">$</span>default <span class="sc">==</span> <span class="st">"yes"</span>, <span class="dv">1</span>, <span class="dv">0</span>), </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">predicted =</span> pred[,<span class="st">"yes"</span>])                    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8175824</code></pre>
</div>
</div>
</section>
<section id="tuning-a-random-forest-via-mtry" class="level2">
<h2 class="anchored" data-anchor-id="tuning-a-random-forest-via-mtry">Tuning a Random Forest via mtry</h2>
<p>In this exercise, you will use the randomForest::tuneRF() to tune mtry (by training several models). This function is a specific utility to tune the mtry parameter based on OOB error, which is helpful when you want a quick &amp; easy way to tune your model. A more generic way of tuning Random Forest parameters will be presented in the following exercise.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute the tuning process</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)              </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">tuneRF</span>(<span class="at">x =</span> <span class="fu">subset</span>(credit_train, <span class="at">select =</span> <span class="sc">-</span>default),</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">y =</span> credit_train<span class="sc">$</span>default,</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">ntreeTry =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>mtry = 4  OOB error = 24.12% 
Searching left ...
mtry = 2    OOB error = 24.5% 
-0.01554404 0.05 
Searching right ...
mtry = 8    OOB error = 23.87% 
0.01036269 0.05 </code></pre>
</div>
<div class="cell-output-display">
<p><img src="ml_tree_methods_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at results</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      mtry OOBError
2.OOB    2  0.24500
4.OOB    4  0.24125
8.OOB    8  0.23875</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the mtry value that minimizes OOB Error</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>mtry_opt <span class="ot">&lt;-</span> res[,<span class="st">"mtry"</span>][<span class="fu">which.min</span>(res[,<span class="st">"OOBError"</span>])]</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mtry_opt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>8.OOB 
    8 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># If you just want to return the best RF model (rather than results)</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co"># you can set `doBest = TRUE` in `tuneRF()` to return the best RF model</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="co"># instead of a set performance matrix.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="tuning-a-random-forest-via-tree-depth" class="level2">
<h2 class="anchored" data-anchor-id="tuning-a-random-forest-via-tree-depth">Tuning a Random Forest via tree depth</h2>
<p>In Chapter 2, we created a manual grid of hyperparameters using the expand.grid() function and wrote code that trained and evaluated the models of the grid in a loop. In this exercise, you will create a grid of mtry, nodesize and sampsize values. In this example, we will identify the “best model” based on OOB error. The best model is defined as the model from our grid which minimizes OOB error. Keep in mind that there are other ways to select a best model from a grid, such as choosing the best model based on validation AUC. However, for this exercise, we will use the built-in OOB error calculations instead of using a separate validation set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Establish a list of possible values for mtry, nodesize and sampsize</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>mtry <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">4</span>, <span class="fu">ncol</span>(credit_train) <span class="sc">*</span> <span class="fl">0.8</span>, <span class="dv">2</span>)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>nodesize <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">2</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>sampsize <span class="ot">&lt;-</span> <span class="fu">nrow</span>(credit_train) <span class="sc">*</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.8</span>)</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data frame containing all combinations </span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>hyper_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">mtry =</span> mtry, <span class="at">nodesize =</span> nodesize, <span class="at">sampsize =</span> sampsize)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty vector to store OOB error values</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>oob_err <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Write a loop over the rows of hyper_grid to train the grid of models</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(hyper_grid)) {</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train a Random Forest model</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(<span class="at">formula =</span> default <span class="sc">~</span> ., </span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> credit_train,</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>                          <span class="at">mtry =</span> hyper_grid<span class="sc">$</span>mtry[i],</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>                          <span class="at">nodesize =</span> hyper_grid<span class="sc">$</span>nodesize[i],</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>                          <span class="at">sampsize =</span> hyper_grid<span class="sc">$</span>sampsize[i])</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>                          </span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store OOB error for the model                      </span></span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>    oob_err[i] <span class="ot">&lt;-</span> model<span class="sc">$</span>err.rate[<span class="fu">nrow</span>(model<span class="sc">$</span>err.rate), <span class="st">"OOB"</span>]</span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify optimal set of hyperparmeters based on OOB error</span></span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>opt_i <span class="ot">&lt;-</span> <span class="fu">which.min</span>(oob_err)</span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hyper_grid[opt_i,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mtry nodesize sampsize
17    6        3      640</code></pre>
</div>
</div>
</section>
<section id="bagged-trees-vs.-boosted-trees" class="level2">
<h2 class="anchored" data-anchor-id="bagged-trees-vs.-boosted-trees">Bagged trees vs.&nbsp;boosted trees</h2>
<p>What is the main difference between bagged trees and boosted trees?</p>
<ul>
<li>Boosted trees improve the model fit by considering past fits and bagged trees do not</li>
</ul>
</section>
<section id="train-a-gbm-model" class="level2">
<h2 class="anchored" data-anchor-id="train-a-gbm-model">Train a GBM model</h2>
<p>Here you will use the gbm() function to train a GBM classifier to predict loan default. You will train a 10,000-tree GBM on the credit_train dataset, which is pre-loaded into your workspace. Using such a large number of trees (10,000) is probably not optimal for a GBM model, but we will build more trees than we need and then select the optimal number of trees based on early performance-based stopping. The best GBM model will likely contain fewer trees than we started with. For binary classification, gbm() requires the response to be encoded as 0/1 (numeric), so we will have to convert from a “no/yes” factor to a 0/1 numeric response column.</p>
<p>Also, the the gbm() function requires the user to specify a distribution argument. For a binary classification problem, you should set distribution = “bernoulli”. The Bernoulli distribution models a binary response.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gbm)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert "yes" to 1, "no" to 0</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>credit_train<span class="sc">$</span>default <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">as.character</span>(credit_train<span class="sc">$</span>default) <span class="sc">==</span> <span class="st">"yes"</span>, <span class="dv">1</span>, <span class="dv">0</span>) </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Train a 10000-tree GBM model</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>credit_model <span class="ot">&lt;-</span> <span class="fu">gbm</span>(<span class="at">formula =</span> default <span class="sc">~</span> ., </span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">distribution =</span> <span class="st">"bernoulli"</span>, </span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> credit_train,</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n.trees =</span>  <span class="dv">10000</span>)</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the model object                    </span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(credit_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>gbm(formula = default ~ ., distribution = "bernoulli", data = credit_train, 
    n.trees = 10000)
A gradient boosted model with bernoulli loss function.
10000 iterations were performed.
There were 16 predictors of which 16 had non-zero influence.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># summary() prints variable importance</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(credit_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ml_tree_methods_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                      var    rel.inf
amount                             amount 22.0897595
age                                   age 17.9626175
credit_history             credit_history 10.6369658
purpose                           purpose 10.2584546
employment_duration   employment_duration  8.8596192
checking_balance         checking_balance  6.4650840
months_loan_duration months_loan_duration  5.8863990
savings_balance           savings_balance  3.7722735
job                                   job  2.9418015
other_credit                 other_credit  2.8613862
housing                           housing  2.5237773
years_at_residence     years_at_residence  2.3409228
percent_of_income       percent_of_income  1.7687143
phone                               phone  0.6373101
existing_loans_count existing_loans_count  0.5870700
dependents                     dependents  0.4078447</code></pre>
</div>
</div>
</section>
<section id="prediction-using-a-gbm-model" class="level2">
<h2 class="anchored" data-anchor-id="prediction-using-a-gbm-model">Prediction using a GBM model</h2>
<p>The gbm package uses a predict() function to generate predictions from a model, similar to many other machine learning packages in R. When you see a function like predict() that works on many different types of input (a GBM model, a RF model, a GLM model, etc), that indicates that predict() is an “alias” for a GBM-specific version of that function. The GBM specific version of that function is predict.gbm(), but for convenience sake, we can just use predict() (either works).</p>
<p>One thing that’s particular to the predict.gbm() however, is that you need to specify the number of trees used in the prediction. There is no default, so you have to specify this manually. For now, we can use the same number of trees that we specified when training the model, which is 10,000 (though this may not be the optimal number to use).</p>
<p>Another argument that you can specify is type, which is only relevant to Bernoulli and Poisson distributed outcomes. When using Bernoulli loss, the returned value is on the log odds scale by default and for Poisson, it’s on the log scale. If instead you specify type = “response”, then gbm converts the predicted values back to the same scale as the outcome. This will convert the predicted values into probabilities for Bernoulli and expected counts for Poisson.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we converted the training response col, let's also convert the test response col</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>credit_test<span class="sc">$</span>default <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(credit_test<span class="sc">$</span>default <span class="sc">==</span> <span class="st">"yes"</span>, <span class="dv">1</span>, <span class="dv">0</span>) </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions on the test set</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>preds1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_model, </span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">newdata =</span> credit_test,</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">n.trees =</span> <span class="dv">10000</span> )</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions on the test set (scale to response)</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>preds2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_model, </span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">newdata =</span> credit_test,</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">n.trees =</span> <span class="dv">10000</span>,</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the range of the two sets of predictions</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(preds1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -6.004812  4.646991</code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(preds2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.002460783 0.990500685</code></pre>
</div>
</div>
</section>
<section id="evaluate-test-set-auc-1" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-test-set-auc-1">Evaluate test set AUC</h2>
<p>Compute test set AUC of the GBM model for the two sets of predictions. We will notice that they are the same value. That’s because AUC is a rank-based metric, so changing the actual values does not change the value of the AUC.</p>
<p>However, if we were to use a scale-aware metric like RMSE to evaluate performance, we would want to make sure we converted the predictions back to the original scale of the response.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the test set AUCs using the two sets of preditions &amp; compare</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">auc</span>(<span class="at">actual =</span> credit_test<span class="sc">$</span>default, <span class="at">predicted =</span> preds1)  <span class="co">#default</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7142857</code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">auc</span>(<span class="at">actual =</span> credit_test<span class="sc">$</span>default, <span class="at">predicted =</span> preds2)  <span class="co">#rescaled</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7142857</code></pre>
</div>
</div>
</section>
<section id="early-stopping-in-gbms" class="level2">
<h2 class="anchored" data-anchor-id="early-stopping-in-gbms">Early stopping in GBMs</h2>
<p>Use the gbm.perf() function to estimate the optimal number of boosting iterations (aka n.trees) for a GBM model object using both OOB and CV error. When you set out to train a large number of trees in a GBM (such as 10,000) and you use a validation method to determine an earlier (smaller) number of trees, then that’s called “early stopping”. The term “early stopping” is not unique to GBMs, but can describe auto-tuning the number of iterations in an iterative learning algorithm.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimal ntree estimate based on OOB</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>ntree_opt_oob <span class="ot">&lt;-</span> <span class="fu">gbm.perf</span>(<span class="at">object =</span> credit_model, </span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">method =</span> <span class="st">"OOB"</span>, </span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">oobag.curve =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ml_tree_methods_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="ml_tree_methods_files/figure-html/unnamed-chunk-27-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train a CV GBM model</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>credit_model_cv <span class="ot">&lt;-</span> <span class="fu">gbm</span>(<span class="at">formula =</span> default <span class="sc">~</span> ., </span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">distribution =</span> <span class="st">"bernoulli"</span>, </span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> credit_train,</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">n.trees =</span> <span class="dv">10000</span>,</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cv.folds =</span> <span class="dv">5</span>)</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimal ntree estimate based on CV</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>ntree_opt_cv <span class="ot">&lt;-</span> <span class="fu">gbm.perf</span>(<span class="at">object =</span> credit_model_cv , </span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">"cv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ml_tree_methods_files/figure-html/unnamed-chunk-27-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the estimates                         </span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"Optimal n.trees (OOB Estimate): "</span>, ntree_opt_oob))                         </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Optimal n.trees (OOB Estimate): 76"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"Optimal n.trees (CV Estimate): "</span>, ntree_opt_cv))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Optimal n.trees (CV Estimate): 127"</code></pre>
</div>
</div>
</section>
<section id="oob-vs-cv-based-early-stopping" class="level2">
<h2 class="anchored" data-anchor-id="oob-vs-cv-based-early-stopping">OOB vs CV-based early stopping</h2>
<p>In the previous exercise, we used OOB error and cross-validated error to estimate the optimal number of trees in the GBM. These are two different ways to estimate the optimal number of trees, so in this exercise we will compare the performance of the models on a test set. We can use the same model object to make both of these estimates since the predict.gbm() function allows you to use any subset of the total number of trees (in our case, the total number is 10,000).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions on the test set using ntree_opt_oob number of trees</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>preds1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_model, </span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">newdata =</span> credit_test,</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">n.trees =</span> ntree_opt_oob)</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions on the test set using ntree_opt_cv number of trees</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>gbm_preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> credit_model, </span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">newdata =</span> credit_test,</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">n.trees =</span> ntree_opt_cv)   </span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the test set AUCs using the two sets of preditions &amp; compare</span></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>auc1 <span class="ot">&lt;-</span> <span class="fu">auc</span>(<span class="at">actual =</span> credit_test<span class="sc">$</span>default, <span class="at">predicted =</span> preds1)  <span class="co">#OOB</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>auc2 <span class="ot">&lt;-</span> <span class="fu">auc</span>(<span class="at">actual =</span> credit_test<span class="sc">$</span>default, <span class="at">predicted =</span>gbm_preds)  <span class="co">#CV </span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare AUC </span></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"Test set AUC (OOB): "</span>, auc1))                         </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Test set AUC (OOB): 0.802527472527472"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"Test set AUC (CV): "</span>, auc2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Test set AUC (CV): 0.792527472527473"</code></pre>
</div>
</div>
</section>
<section id="compare-all-models-based-on-auc" class="level2">
<h2 class="anchored" data-anchor-id="compare-all-models-based-on-auc">Compare all models based on AUC</h2>
<p>In this final exercise, we will perform a model comparison across all types of models that we’ve learned about so far: Decision Trees, Bagged Trees, Random Forest and Gradient Boosting Machine (GBM). The models were all trained on the same training set, credit_train, and predictions were made for the credit_test dataset.</p>
<p>We have pre-loaded four sets of test set predictions, generated using the models we trained in previous chapters (one for each model type). The numbers stored in the prediction vectors are the raw predicted values themselves – not the predicted class labels. Using the raw predicted values, we can calculate test set AUC for each model and compare the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co">#credit_train$default &lt;-  factor(credit_train$default, levels  = c(0, 1))</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="co">#credit_test$default &lt;-  factor(credit_test$default, levels = c(0, 1))</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>myFolds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(credit_train<span class="sc">$</span>default, <span class="at">k =</span> <span class="dv">5</span>)</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="co"># tuneGridRf &lt;- data.frame(</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   .mtry = c(2, 3, 7),</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   .splitrule = "variance",</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   .min.node.size = 5</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>myControl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"cv"</span>,</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">number =</span> <span class="dv">5</span>,</span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">summaryFunction =</span> twoClassSummary,</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">classProbs =</span> <span class="cn">TRUE</span>, <span class="co"># IMPORTANT!</span></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">verboseIter =</span> <span class="cn">FALSE</span>,</span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">index =</span> myFolds</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span>  <span class="fu">factor</span>(credit_train<span class="sc">$</span>default,<span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>),  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"yes"</span>, <span class="st">"no"</span>))</span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> credit_train <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>default)</span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>model_rf <span class="ot">&lt;-</span> <span class="fu">train</span>(<span class="at">x =</span>  x ,</span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y=</span> y,</span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"ranger"</span>,</span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a>                  <span class="at">classification =</span> <span class="cn">TRUE</span>,</span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">metric =</span> <span class="st">"ROC"</span>,</span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trControl =</span> myControl)</span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a>rf_preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_rf, <span class="at">newdata =</span> credit_test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a>rf_preds <span class="ot">&lt;-</span> rf_preds[, <span class="st">"yes"</span>]</span>
<span id="cb109-32"><a href="#cb109-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-33"><a href="#cb109-33" aria-hidden="true" tabindex="-1"></a>model_bag <span class="ot">&lt;-</span> <span class="fu">train</span>(<span class="at">x =</span> x, </span>
<span id="cb109-34"><a href="#cb109-34" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> y,</span>
<span id="cb109-35"><a href="#cb109-35" aria-hidden="true" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">"treebag"</span>,</span>
<span id="cb109-36"><a href="#cb109-36" aria-hidden="true" tabindex="-1"></a>                   <span class="at">metric =</span> <span class="st">"ROC"</span>,</span>
<span id="cb109-37"><a href="#cb109-37" aria-hidden="true" tabindex="-1"></a>                   <span class="at">trControl =</span> myControl)</span>
<span id="cb109-38"><a href="#cb109-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-39"><a href="#cb109-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-40"><a href="#cb109-40" aria-hidden="true" tabindex="-1"></a>bag_preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_bag, <span class="at">newdata =</span> credit_test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb109-41"><a href="#cb109-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-42"><a href="#cb109-42" aria-hidden="true" tabindex="-1"></a>bag_preds  <span class="ot">&lt;-</span>bag_preds[, <span class="st">"yes"</span>]</span>
<span id="cb109-43"><a href="#cb109-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-44"><a href="#cb109-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-45"><a href="#cb109-45" aria-hidden="true" tabindex="-1"></a>hyperparams_gbm <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">n.trees =</span> <span class="fu">seq</span>(<span class="dv">100</span>,<span class="dv">500</span>, <span class="at">by =</span> <span class="dv">50</span>), </span>
<span id="cb109-46"><a href="#cb109-46" aria-hidden="true" tabindex="-1"></a>                           <span class="at">interaction.depth =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, </span>
<span id="cb109-47"><a href="#cb109-47" aria-hidden="true" tabindex="-1"></a>                           <span class="at">shrinkage =</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="at">by =</span> .<span class="dv">1</span>), </span>
<span id="cb109-48"><a href="#cb109-48" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n.minobsinnode =</span> <span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">30</span>, <span class="dv">10</span>))</span>
<span id="cb109-49"><a href="#cb109-49" aria-hidden="true" tabindex="-1"></a>model_gbm <span class="ot">&lt;-</span> <span class="fu">train</span>(<span class="at">x =</span> x,</span>
<span id="cb109-50"><a href="#cb109-50" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> y,</span>
<span id="cb109-51"><a href="#cb109-51" aria-hidden="true" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">"gbm"</span>,</span>
<span id="cb109-52"><a href="#cb109-52" aria-hidden="true" tabindex="-1"></a>                   <span class="co">#tuneGrid = hyperparams_gbm,</span></span>
<span id="cb109-53"><a href="#cb109-53" aria-hidden="true" tabindex="-1"></a>                   <span class="at">metric =</span> <span class="st">"ROC"</span>,</span>
<span id="cb109-54"><a href="#cb109-54" aria-hidden="true" tabindex="-1"></a>                   <span class="at">trControl =</span> myControl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.2650            -nan     0.1000    0.0039
     2        1.2427            -nan     0.1000    0.0095
     3        1.2226            -nan     0.1000    0.0072
     4        1.2078            -nan     0.1000    0.0015
     5        1.1963            -nan     0.1000    0.0018
     6        1.1816            -nan     0.1000    0.0039
     7        1.1712            -nan     0.1000    0.0007
     8        1.1601            -nan     0.1000    0.0007
     9        1.1506            -nan     0.1000   -0.0010
    10        1.1402            -nan     0.1000    0.0044
    20        1.0561            -nan     0.1000    0.0007
    40        0.9714            -nan     0.1000   -0.0006
    60        0.9192            -nan     0.1000   -0.0048
    80        0.8788            -nan     0.1000   -0.0041
   100        0.8515            -nan     0.1000   -0.0014
   120        0.8191            -nan     0.1000   -0.0056
   140        0.7927            -nan     0.1000   -0.0041
   150        0.7834            -nan     0.1000   -0.0037

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.2528            -nan     0.1000    0.0081
     2        1.2246            -nan     0.1000    0.0064
     3        1.1934            -nan     0.1000    0.0106
     4        1.1729            -nan     0.1000    0.0022
     5        1.1475            -nan     0.1000    0.0070
     6        1.1305            -nan     0.1000    0.0000
     7        1.1180            -nan     0.1000    0.0005
     8        1.0926            -nan     0.1000    0.0005
     9        1.0726            -nan     0.1000    0.0045
    10        1.0576            -nan     0.1000   -0.0013
    20        0.9674            -nan     0.1000   -0.0046
    40        0.8488            -nan     0.1000   -0.0153
    60        0.7727            -nan     0.1000   -0.0039
    80        0.6981            -nan     0.1000   -0.0045
   100        0.6502            -nan     0.1000   -0.0015
   120        0.6014            -nan     0.1000   -0.0036
   140        0.5684            -nan     0.1000   -0.0033
   150        0.5464            -nan     0.1000   -0.0009

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.2438            -nan     0.1000    0.0155
     2        1.2147            -nan     0.1000    0.0054
     3        1.1900            -nan     0.1000    0.0060
     4        1.1626            -nan     0.1000    0.0052
     5        1.1412            -nan     0.1000    0.0017
     6        1.1199            -nan     0.1000    0.0026
     7        1.0992            -nan     0.1000    0.0009
     8        1.0813            -nan     0.1000   -0.0046
     9        1.0672            -nan     0.1000   -0.0023
    10        1.0506            -nan     0.1000   -0.0080
    20        0.9000            -nan     0.1000   -0.0032
    40        0.7530            -nan     0.1000   -0.0073
    60        0.6553            -nan     0.1000   -0.0054
    80        0.5664            -nan     0.1000   -0.0073
   100        0.5062            -nan     0.1000   -0.0059
   120        0.4603            -nan     0.1000   -0.0057
   140        0.4111            -nan     0.1000   -0.0043
   150        0.3856            -nan     0.1000   -0.0035

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.0493            -nan     0.1000    0.0012
     2        1.0312            -nan     0.1000    0.0065
     3        1.0190            -nan     0.1000   -0.0028
     4        1.0054            -nan     0.1000    0.0000
     5        0.9983            -nan     0.1000   -0.0054
     6        0.9814            -nan     0.1000   -0.0030
     7        0.9722            -nan     0.1000    0.0000
     8        0.9649            -nan     0.1000    0.0024
     9        0.9579            -nan     0.1000    0.0004
    10        0.9509            -nan     0.1000    0.0011
    20        0.9017            -nan     0.1000   -0.0067
    40        0.8232            -nan     0.1000   -0.0027
    60        0.7655            -nan     0.1000   -0.0019
    80        0.7302            -nan     0.1000   -0.0026
   100        0.6907            -nan     0.1000   -0.0018
   120        0.6691            -nan     0.1000   -0.0074
   140        0.6566            -nan     0.1000   -0.0030
   150        0.6459            -nan     0.1000   -0.0042

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.0321            -nan     0.1000    0.0031
     2        1.0123            -nan     0.1000   -0.0019
     3        0.9904            -nan     0.1000    0.0021
     4        0.9813            -nan     0.1000   -0.0088
     5        0.9736            -nan     0.1000   -0.0005
     6        0.9543            -nan     0.1000    0.0044
     7        0.9453            -nan     0.1000   -0.0038
     8        0.9327            -nan     0.1000   -0.0033
     9        0.9221            -nan     0.1000   -0.0018
    10        0.9059            -nan     0.1000    0.0043
    20        0.8193            -nan     0.1000   -0.0042
    40        0.6906            -nan     0.1000   -0.0047
    60        0.6227            -nan     0.1000   -0.0049
    80        0.5567            -nan     0.1000   -0.0028
   100        0.5066            -nan     0.1000   -0.0055
   120        0.4600            -nan     0.1000   -0.0059
   140        0.4173            -nan     0.1000   -0.0066
   150        0.4008            -nan     0.1000   -0.0024

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.0386            -nan     0.1000    0.0032
     2        1.0199            -nan     0.1000    0.0012
     3        1.0082            -nan     0.1000   -0.0025
     4        0.9934            -nan     0.1000   -0.0032
     5        0.9699            -nan     0.1000   -0.0042
     6        0.9500            -nan     0.1000   -0.0011
     7        0.9247            -nan     0.1000    0.0039
     8        0.9062            -nan     0.1000   -0.0055
     9        0.8931            -nan     0.1000   -0.0046
    10        0.8790            -nan     0.1000   -0.0041
    20        0.7603            -nan     0.1000   -0.0044
    40        0.6094            -nan     0.1000   -0.0032
    60        0.5139            -nan     0.1000   -0.0026
    80        0.4287            -nan     0.1000   -0.0012
   100        0.3686            -nan     0.1000   -0.0040
   120        0.3319            -nan     0.1000   -0.0055
   140        0.2831            -nan     0.1000   -0.0024
   150        0.2612            -nan     0.1000   -0.0024

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.1727            -nan     0.1000    0.0048
     2        1.1566            -nan     0.1000    0.0042
     3        1.1399            -nan     0.1000    0.0027
     4        1.1174            -nan     0.1000    0.0048
     5        1.0990            -nan     0.1000    0.0023
     6        1.0846            -nan     0.1000    0.0023
     7        1.0754            -nan     0.1000    0.0018
     8        1.0645            -nan     0.1000    0.0035
     9        1.0550            -nan     0.1000   -0.0008
    10        1.0466            -nan     0.1000   -0.0008
    20        0.9777            -nan     0.1000    0.0019
    40        0.8611            -nan     0.1000   -0.0011
    60        0.7978            -nan     0.1000   -0.0013
    80        0.7429            -nan     0.1000   -0.0040
   100        0.7077            -nan     0.1000   -0.0046
   120        0.6889            -nan     0.1000   -0.0027
   140        0.6654            -nan     0.1000   -0.0016
   150        0.6559            -nan     0.1000   -0.0011

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.1591            -nan     0.1000    0.0058
     2        1.1253            -nan     0.1000    0.0114
     3        1.0902            -nan     0.1000    0.0116
     4        1.0662            -nan     0.1000    0.0025
     5        1.0593            -nan     0.1000   -0.0112
     6        1.0380            -nan     0.1000    0.0034
     7        1.0167            -nan     0.1000    0.0040
     8        0.9910            -nan     0.1000    0.0052
     9        0.9677            -nan     0.1000    0.0079
    10        0.9546            -nan     0.1000   -0.0062
    20        0.8419            -nan     0.1000   -0.0025
    40        0.6865            -nan     0.1000   -0.0037
    60        0.6017            -nan     0.1000   -0.0013
    80        0.5465            -nan     0.1000   -0.0042
   100        0.4891            -nan     0.1000   -0.0037
   120        0.4468            -nan     0.1000   -0.0030
   140        0.4141            -nan     0.1000   -0.0066
   150        0.3985            -nan     0.1000   -0.0030

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.1740            -nan     0.1000   -0.0038
     2        1.1288            -nan     0.1000    0.0121
     3        1.0920            -nan     0.1000    0.0046
     4        1.0637            -nan     0.1000    0.0088
     5        1.0287            -nan     0.1000    0.0107
     6        1.0025            -nan     0.1000   -0.0025
     7        0.9746            -nan     0.1000    0.0011
     8        0.9501            -nan     0.1000    0.0005
     9        0.9284            -nan     0.1000   -0.0074
    10        0.9116            -nan     0.1000   -0.0016
    20        0.7753            -nan     0.1000   -0.0005
    40        0.6060            -nan     0.1000   -0.0030
    60        0.4993            -nan     0.1000    0.0012
    80        0.4251            -nan     0.1000   -0.0042
   100        0.3696            -nan     0.1000   -0.0020
   120        0.3210            -nan     0.1000   -0.0020
   140        0.2723            -nan     0.1000   -0.0012
   150        0.2511            -nan     0.1000   -0.0026

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.2101            -nan     0.1000   -0.0015
     2        1.1790            -nan     0.1000    0.0183
     3        1.1480            -nan     0.1000    0.0163
     4        1.1148            -nan     0.1000    0.0101
     5        1.0826            -nan     0.1000    0.0125
     6        1.0723            -nan     0.1000    0.0024
     7        1.0499            -nan     0.1000    0.0121
     8        1.0395            -nan     0.1000   -0.0027
     9        1.0187            -nan     0.1000    0.0074
    10        1.0063            -nan     0.1000    0.0043
    20        0.9174            -nan     0.1000   -0.0016
    40        0.8156            -nan     0.1000   -0.0010
    60        0.7405            -nan     0.1000   -0.0031
    80        0.7003            -nan     0.1000   -0.0016
   100        0.6655            -nan     0.1000   -0.0023
   120        0.6434            -nan     0.1000   -0.0027
   140        0.6147            -nan     0.1000   -0.0048
   150        0.6067            -nan     0.1000   -0.0012

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.1551            -nan     0.1000    0.0184
     2        1.1113            -nan     0.1000    0.0181
     3        1.0712            -nan     0.1000    0.0178
     4        1.0338            -nan     0.1000    0.0092
     5        1.0134            -nan     0.1000    0.0058
     6        0.9854            -nan     0.1000    0.0107
     7        0.9625            -nan     0.1000    0.0084
     8        0.9432            -nan     0.1000    0.0041
     9        0.9335            -nan     0.1000   -0.0023
    10        0.9221            -nan     0.1000   -0.0025
    20        0.8041            -nan     0.1000   -0.0017
    40        0.6691            -nan     0.1000   -0.0066
    60        0.5943            -nan     0.1000   -0.0049
    80        0.5265            -nan     0.1000   -0.0049
   100        0.4683            -nan     0.1000   -0.0041
   120        0.4215            -nan     0.1000   -0.0018
   140        0.3862            -nan     0.1000   -0.0031
   150        0.3698            -nan     0.1000   -0.0018

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.1719            -nan     0.1000    0.0194
     2        1.1111            -nan     0.1000    0.0264
     3        1.0633            -nan     0.1000    0.0174
     4        1.0323            -nan     0.1000    0.0050
     5        1.0085            -nan     0.1000    0.0025
     6        0.9997            -nan     0.1000   -0.0087
     7        0.9728            -nan     0.1000    0.0075
     8        0.9311            -nan     0.1000    0.0128
     9        0.9227            -nan     0.1000   -0.0048
    10        0.9037            -nan     0.1000    0.0010
    20        0.7400            -nan     0.1000    0.0013
    40        0.5865            -nan     0.1000   -0.0055
    60        0.4703            -nan     0.1000   -0.0030
    80        0.3800            -nan     0.1000   -0.0036
   100        0.3205            -nan     0.1000   -0.0015
   120        0.2803            -nan     0.1000   -0.0023
   140        0.2401            -nan     0.1000   -0.0015
   150        0.2183            -nan     0.1000   -0.0013

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.1683            -nan     0.1000    0.0149
     2        1.1484            -nan     0.1000    0.0054
     3        1.1290            -nan     0.1000    0.0081
     4        1.1046            -nan     0.1000    0.0100
     5        1.0993            -nan     0.1000   -0.0032
     6        1.0877            -nan     0.1000    0.0007
     7        1.0761            -nan     0.1000    0.0006
     8        1.0694            -nan     0.1000    0.0002
     9        1.0624            -nan     0.1000   -0.0023
    10        1.0458            -nan     0.1000   -0.0009
    20        0.9643            -nan     0.1000   -0.0015
    40        0.8710            -nan     0.1000   -0.0019
    60        0.8263            -nan     0.1000   -0.0067
    80        0.7926            -nan     0.1000   -0.0050
   100        0.7772            -nan     0.1000   -0.0060
   120        0.7532            -nan     0.1000   -0.0031
   140        0.7267            -nan     0.1000   -0.0032
   150        0.7225            -nan     0.1000   -0.0028

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.1726            -nan     0.1000    0.0081
     2        1.1329            -nan     0.1000    0.0210
     3        1.0909            -nan     0.1000    0.0075
     4        1.0686            -nan     0.1000    0.0064
     5        1.0454            -nan     0.1000    0.0060
     6        1.0313            -nan     0.1000   -0.0003
     7        1.0107            -nan     0.1000    0.0060
     8        0.9922            -nan     0.1000    0.0039
     9        0.9778            -nan     0.1000   -0.0013
    10        0.9617            -nan     0.1000    0.0008
    20        0.8664            -nan     0.1000   -0.0030
    40        0.7598            -nan     0.1000   -0.0031
    60        0.6822            -nan     0.1000   -0.0028
    80        0.6271            -nan     0.1000    0.0005
   100        0.5784            -nan     0.1000   -0.0030
   120        0.5264            -nan     0.1000   -0.0046
   140        0.4798            -nan     0.1000   -0.0042
   150        0.4659            -nan     0.1000   -0.0067

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.1689            -nan     0.1000    0.0036
     2        1.1327            -nan     0.1000    0.0121
     3        1.0929            -nan     0.1000    0.0143
     4        1.0462            -nan     0.1000    0.0100
     5        1.0181            -nan     0.1000    0.0078
     6        0.9997            -nan     0.1000    0.0011
     7        0.9750            -nan     0.1000    0.0056
     8        0.9586            -nan     0.1000   -0.0003
     9        0.9303            -nan     0.1000    0.0071
    10        0.9179            -nan     0.1000   -0.0073
    20        0.8060            -nan     0.1000   -0.0029
    40        0.6746            -nan     0.1000   -0.0055
    60        0.5787            -nan     0.1000   -0.0073
    80        0.4995            -nan     0.1000   -0.0056
   100        0.4327            -nan     0.1000   -0.0024
   120        0.3789            -nan     0.1000   -0.0030
   140        0.3350            -nan     0.1000   -0.0035
   150        0.3100            -nan     0.1000   -0.0036

Iter   TrainDeviance   ValidDeviance   StepSize   Improve
     1        1.1819            -nan     0.1000    0.0092
     2        1.1663            -nan     0.1000    0.0076
     3        1.1517            -nan     0.1000    0.0061
     4        1.1427            -nan     0.1000    0.0039
     5        1.1339            -nan     0.1000    0.0044
     6        1.1280            -nan     0.1000    0.0022
     7        1.1230            -nan     0.1000    0.0019
     8        1.1151            -nan     0.1000    0.0023
     9        1.1083            -nan     0.1000    0.0030
    10        1.0985            -nan     0.1000    0.0035
    20        1.0537            -nan     0.1000    0.0010
    40        1.0014            -nan     0.1000   -0.0008
    50        0.9848            -nan     0.1000   -0.0002</code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>gbm_preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_gbm, <span class="at">newdata =</span> credit_test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>gbm_preds  <span class="ot">&lt;-</span> gbm_preds[, <span class="st">"yes"</span>]</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>model_dt <span class="ot">&lt;-</span> <span class="fu">train</span>(<span class="at">x =</span> x,</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> y,</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">"rpart"</span>,</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">metric =</span> <span class="st">"ROC"</span>,</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">trControl =</span> myControl)</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>dt_preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_dt, <span class="at">newdata =</span> credit_test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>dt_preds  <span class="ot">&lt;-</span> dt_preds[, <span class="st">"yes"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the test set AUCs using the two sets of predictions &amp; compare</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>actual <span class="ot">&lt;-</span> credit_test<span class="sc">$</span>default</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>dt_auc <span class="ot">&lt;-</span> <span class="fu">auc</span>(<span class="at">actual =</span> actual, <span class="at">predicted =</span> dt_preds)</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>bag_auc <span class="ot">&lt;-</span> <span class="fu">auc</span>(<span class="at">actual =</span> actual, <span class="at">predicted =</span> bag_preds)</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>rf_auc <span class="ot">&lt;-</span> <span class="fu">auc</span>(<span class="at">actual =</span> actual, <span class="at">predicted =</span> rf_preds)</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>gbm_auc <span class="ot">&lt;-</span> <span class="fu">auc</span>(<span class="at">actual =</span> actual, <span class="at">predicted =</span> gbm_preds)</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a><span class="co"># # Print results</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sprintf</span>(<span class="st">"Decision Tree Test AUC: %.3f"</span>, dt_auc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Decision Tree Test AUC: 0.770"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sprintf</span>(<span class="st">"Bagged Trees Test AUC: %.3f"</span>, bag_auc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Bagged Trees Test AUC: 0.803"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sprintf</span>(<span class="st">"Random Forest Test AUC: %.3f"</span>, rf_auc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Random Forest Test AUC: 0.814"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sprintf</span>(<span class="st">"GBM Test AUC: %.3f"</span>, gbm_auc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "GBM Test AUC: 0.804"</code></pre>
</div>
</div>
</section>
<section id="plot-compare-roc-curves" class="level2">
<h2 class="anchored" data-anchor-id="plot-compare-roc-curves">Plot &amp; compare ROC curves</h2>
<p>We conclude this course by plotting the ROC curves for all the models (one from each chapter) on the same graph. The ROCR package provides the prediction() and performance() functions which generate the data required for plotting the ROC curve, given a set of predictions and actual (true) values.</p>
<p>The more “up and to the left” the ROC curve of a model is, the better the model. The AUC performance metric is literally the “Area Under the ROC Curve”, so the greater the area under this curve, the higher the AUC, and the better-performing the model is.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ROCR)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="co"># List of predictions</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>preds_list <span class="ot">&lt;-</span> <span class="fu">list</span>(dt_preds, bag_preds, rf_preds, gbm_preds)</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="co"># List of actual values (same for all)</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">length</span>(preds_list)</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>actuals_list <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">list</span>(credit_test<span class="sc">$</span>default), m)</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the ROC curves</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(preds_list, actuals_list)</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>rocs <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="st">"tpr"</span>, <span class="st">"fpr"</span>)</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rocs, <span class="at">col =</span> <span class="fu">as.list</span>(<span class="dv">1</span><span class="sc">:</span>m), <span class="at">main =</span> <span class="st">"Test Set ROC Curves"</span>)</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x =</span> <span class="st">"bottomright"</span>, </span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Decision Tree"</span>, <span class="st">"Bagged Trees"</span>, <span class="st">"Random Forest"</span>, <span class="st">"GBM"</span>),</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="dv">1</span><span class="sc">:</span>m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ml_tree_methods_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>