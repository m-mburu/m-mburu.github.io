<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mburu">
<meta name="dcterms.date" content="2022-11-03">

<title>Personal Blog - Anomaly Detection in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../milkyway.jpeg" rel="icon" type="image/jpeg">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


<link rel="stylesheet" href="../../style.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Personal Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../datacamp.html">
 <span class="menu-text">Data Camp Courses</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/m-mburu"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/mmburu_w"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#statistical-outlier-detection" id="toc-statistical-outlier-detection" class="nav-link active" data-scroll-target="#statistical-outlier-detection">Statistical outlier detection</a>
  <ul class="collapse">
  <li><a href="#exploring-the-river-nitrate-data" id="toc-exploring-the-river-nitrate-data" class="nav-link" data-scroll-target="#exploring-the-river-nitrate-data">Exploring the river nitrate data</a></li>
  <li><a href="#visual-check-of-normality" id="toc-visual-check-of-normality" class="nav-link" data-scroll-target="#visual-check-of-normality">Visual check of normality</a></li>
  <li><a href="#grubbs-test" id="toc-grubbs-test" class="nav-link" data-scroll-target="#grubbs-test">Grubbs’ test</a></li>
  <li><a href="#hunting-multiple-outliers-using-grubbs-test" id="toc-hunting-multiple-outliers-using-grubbs-test" class="nav-link" data-scroll-target="#hunting-multiple-outliers-using-grubbs-test">Hunting multiple outliers using Grubbs’ test</a></li>
  <li><a href="#visual-assessment-of-seasonality" id="toc-visual-assessment-of-seasonality" class="nav-link" data-scroll-target="#visual-assessment-of-seasonality">Visual assessment of seasonality</a></li>
  <li><a href="#seasonal-hybrid-esd-algorithm" id="toc-seasonal-hybrid-esd-algorithm" class="nav-link" data-scroll-target="#seasonal-hybrid-esd-algorithm">Seasonal Hybrid ESD algorithm</a></li>
  <li><a href="#interpreting-seasonal-hybrid-esd-output" id="toc-interpreting-seasonal-hybrid-esd-output" class="nav-link" data-scroll-target="#interpreting-seasonal-hybrid-esd-output">Interpreting Seasonal-Hybrid ESD output</a></li>
  </ul></li>
  <li><a href="#distance-and-density-based-anomaly-detection" id="toc-distance-and-density-based-anomaly-detection" class="nav-link" data-scroll-target="#distance-and-density-based-anomaly-detection">Distance and density based anomaly detection</a>
  <ul class="collapse">
  <li><a href="#exploring-wine" id="toc-exploring-wine" class="nav-link" data-scroll-target="#exploring-wine">Exploring wine</a></li>
  <li><a href="#knn-distance-matrix" id="toc-knn-distance-matrix" class="nav-link" data-scroll-target="#knn-distance-matrix">kNN distance matrix</a></li>
  <li><a href="#knn-distance-score" id="toc-knn-distance-score" class="nav-link" data-scroll-target="#knn-distance-score">kNN distance score</a></li>
  <li><a href="#standardizing-features" id="toc-standardizing-features" class="nav-link" data-scroll-target="#standardizing-features">Standardizing features</a></li>
  <li><a href="#appending-the-knn-score" id="toc-appending-the-knn-score" class="nav-link" data-scroll-target="#appending-the-knn-score">Appending the kNN score</a></li>
  <li><a href="#visualizing-knn-distance-score" id="toc-visualizing-knn-distance-score" class="nav-link" data-scroll-target="#visualizing-knn-distance-score">Visualizing kNN distance score</a></li>
  <li><a href="#lof-calculation" id="toc-lof-calculation" class="nav-link" data-scroll-target="#lof-calculation">LOF calculation</a></li>
  <li><a href="#lof-visualization" id="toc-lof-visualization" class="nav-link" data-scroll-target="#lof-visualization">LOF visualization</a></li>
  <li><a href="#lof-vs-knn" id="toc-lof-vs-knn" class="nav-link" data-scroll-target="#lof-vs-knn">LOF vs kNN</a></li>
  </ul></li>
  <li><a href="#isolation-forest" id="toc-isolation-forest" class="nav-link" data-scroll-target="#isolation-forest">Isolation forest</a>
  <ul class="collapse">
  <li><a href="#fit-and-predict-with-an-isolation-tree" id="toc-fit-and-predict-with-an-isolation-tree" class="nav-link" data-scroll-target="#fit-and-predict-with-an-isolation-tree">Fit and predict with an isolation tree</a></li>
  <li><a href="#fit-an-isolation-forest" id="toc-fit-an-isolation-forest" class="nav-link" data-scroll-target="#fit-an-isolation-forest">Fit an isolation forest</a></li>
  <li><a href="#checking-convergence" id="toc-checking-convergence" class="nav-link" data-scroll-target="#checking-convergence">Checking convergence</a></li>
  <li><a href="#a-grid-of-points" id="toc-a-grid-of-points" class="nav-link" data-scroll-target="#a-grid-of-points">A grid of points</a></li>
  <li><a href="#prediction-over-a-grid" id="toc-prediction-over-a-grid" class="nav-link" data-scroll-target="#prediction-over-a-grid">Prediction over a grid</a></li>
  <li><a href="#anomaly-contours" id="toc-anomaly-contours" class="nav-link" data-scroll-target="#anomaly-contours">Anomaly contours</a></li>
  </ul></li>
  <li><a href="#comparing-performance" id="toc-comparing-performance" class="nav-link" data-scroll-target="#comparing-performance">Comparing performance</a>
  <ul class="collapse">
  <li><a href="#thyroid-data" id="toc-thyroid-data" class="nav-link" data-scroll-target="#thyroid-data">Thyroid data</a></li>
  <li><a href="#visualizing-thyroid-disease" id="toc-visualizing-thyroid-disease" class="nav-link" data-scroll-target="#visualizing-thyroid-disease">Visualizing thyroid disease</a></li>
  <li><a href="#anomaly-score" id="toc-anomaly-score" class="nav-link" data-scroll-target="#anomaly-score">Anomaly score</a></li>
  <li><a href="#binarized-scores" id="toc-binarized-scores" class="nav-link" data-scroll-target="#binarized-scores">Binarized scores</a></li>
  <li><a href="#cross-tabulate-binary-scores" id="toc-cross-tabulate-binary-scores" class="nav-link" data-scroll-target="#cross-tabulate-binary-scores">Cross-tabulate binary scores</a></li>
  <li><a href="#thyroid-precision-and-recall" id="toc-thyroid-precision-and-recall" class="nav-link" data-scroll-target="#thyroid-precision-and-recall">Thyroid precision and recall</a></li>
  <li><a href="#converting-character-to-factor" id="toc-converting-character-to-factor" class="nav-link" data-scroll-target="#converting-character-to-factor">Converting character to factor</a></li>
  <li><a href="#isolation-forest-with-factors" id="toc-isolation-forest-with-factors" class="nav-link" data-scroll-target="#isolation-forest-with-factors">Isolation forest with factors</a></li>
  <li><a href="#lof-with-factors" id="toc-lof-with-factors" class="nav-link" data-scroll-target="#lof-with-factors">LOF with factors</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Anomaly Detection in R</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Mburu </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 3, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="statistical-outlier-detection" class="level2">
<h2 class="anchored" data-anchor-id="statistical-outlier-detection">Statistical outlier detection</h2>
<section id="exploring-the-river-nitrate-data" class="level3">
<h3 class="anchored" data-anchor-id="exploring-the-river-nitrate-data">Exploring the river nitrate data</h3>
<p>In this exercise, you’ll explore the river dataset which will be used throughout this chapter to illustrate the use of common anomaly detection techniques. The river data is a data.frame that contains the following three columns:</p>
<p>index - integers describing the order of the nitrate observations nitrate - monthly concentrations of dissolved nitrate found in a river month - a factor containing the month for each nitrate observation You will explore the nitrate column using summary statistics and boxplots to assess whether there may be point anomalies present.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(outliers)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(AnomalyDetection)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(FNN)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"river_data.R"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>data_table <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(DT)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    n_col <span class="ot">=</span> <span class="fu">ncol</span>(df)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datatable</span>(df,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">rownames =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">style =</span> <span class="st">"bootstrap4"</span>, <span class="at">class =</span> <span class="st">'cell-border stripe'</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">options =</span> <span class="fu">list</span>(<span class="at">scrollX =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>                             <span class="at">columnDefs =</span> <span class="fu">list</span>(<span class="fu">list</span>(<span class="at">className =</span> <span class="st">'dt-center'</span>, </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">targets =</span> <span class="dv">0</span><span class="sc">:</span>n_col))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(river) <span class="sc">%&gt;%</span> <span class="fu">data_table</span>()</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics of river nitrate concentrations</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(river<span class="sc">$</span>nitrate)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the distribution of nitrate concentration</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(river<span class="sc">$</span>nitrate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visual-check-of-normality" class="level3">
<h3 class="anchored" data-anchor-id="visual-check-of-normality">Visual check of normality</h3>
<p>Before using Grubbs’ test, you should first check that the observations are plausibly normal. The hist() function in R returns a histogram of the observations, which will help you to form a judgement about the normal assumption. hist() is used as follows</p>
<p>hist(data, xlab = “My x-axis label”, breaks = 30)</p>
<p>data is a vector of numeric values breaks the number of break points used to assign the data to bins xlab an optional character string for the x-axis label</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate the histogram into 40 bins </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(river<span class="sc">$</span>nitrate, <span class="at">xlab =</span> <span class="st">"Nitrate concentration"</span>, <span class="at">breaks =</span> <span class="dv">40</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="grubbs-test" class="level3">
<h3 class="anchored" data-anchor-id="grubbs-test">Grubbs’ test</h3>
<p>We’ve now checked that the data are normal. Now let’s apply Grubbs’ outlier test!</p>
<p>Grubbs’ test assesses whether the value that is farthest from the mean is an outlier - the value could be either the maximum or minimum value. The test is performed using the grubbs.test() function from the outliers package:</p>
<p>grubbs.test(x)</p>
<p>x is the input data as a numeric vector</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply Grubbs' test to the river nitrate data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grubbs.test</span>(river<span class="sc">$</span>nitrate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><em>You can now use Grubbs’ test to check for single outliers. Remember, the lower the p-value returned by the test, the higher the likelihood that the point tested was an outlier.</em></li>
</ul>
</section>
<section id="hunting-multiple-outliers-using-grubbs-test" class="level3">
<h3 class="anchored" data-anchor-id="hunting-multiple-outliers-using-grubbs-test">Hunting multiple outliers using Grubbs’ test</h3>
<p>Grubbs’ test found that the maximum value could be an outlier, but what if there are more? Further outliers can be found by repeating Grubbs’ test, after removing any previously identified outliers from the data.</p>
<p>To identify the point that was tested, the which.min() or which.max() functions can be used to find the index containing the largest or smallest value - remember we know which of these it is from the Grubbs’ test output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply Grubbs' test to the nitrate data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grubbs.test</span>(river<span class="sc">$</span>nitrate)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Use which.max to find row index of the max</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">which.max</span>(river<span class="sc">$</span>nitrate)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Runs Grubbs' test excluding row 156</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">grubbs.test</span>(river<span class="sc">$</span>nitrate[<span class="sc">-</span><span class="dv">156</span>])</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the value tested in the second Grubbs' test</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(river<span class="sc">$</span>nitrate[<span class="sc">-</span><span class="dv">156</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visual-assessment-of-seasonality" class="level3">
<h3 class="anchored" data-anchor-id="visual-assessment-of-seasonality">Visual assessment of seasonality</h3>
<p>The first step when analyzing time series should be to construct graphical summaries that provide insight into important features such as trend, seasonality and possible anomalies. In this exercise, you’ll use several plots to explore thenitrate concentrations as a time series and to identify the period of any seasonal patterns that might be present.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View contents of dataset</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(river)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the time series of nitrate concentrations with time</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nitrate <span class="sc">~</span> index, <span class="at">data =</span> river, <span class="at">type =</span> <span class="st">"o"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a boxplot of nitrate against months</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(nitrate<span class="sc">~</span>months, <span class="at">data =</span> river)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="plot-the-monthly-means" class="level4">
<h4 class="anchored" data-anchor-id="plot-the-monthly-means">Plot the monthly means</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean nitrate by month</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>monthly_mean <span class="ot">&lt;-</span> <span class="fu">tapply</span>(river<span class="sc">$</span>nitrate, river<span class="sc">$</span>months, <span class="at">FUN =</span> mean)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>monthly_mean</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the monthly means </span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(monthly_mean, <span class="at">type =</span> <span class="st">"o"</span>, <span class="at">xlab =</span> <span class="st">"Month"</span>, <span class="at">ylab =</span> <span class="st">"Monthly mean"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-boxplot-of-nitrate-against-months" class="level4">
<h4 class="anchored" data-anchor-id="create-a-boxplot-of-nitrate-against-months">Create a boxplot of nitrate against months</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a boxplot of nitrate against months</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(nitrate<span class="sc">~</span>months, <span class="at">data =</span> river)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="seasonal-hybrid-esd-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="seasonal-hybrid-esd-algorithm">Seasonal Hybrid ESD algorithm</h3>
<p>You’ve identified a repeating seasonal cycle in the nitrate data, with a period of 12 months. You are now ready to apply the Seasonal-Hybrid ESD algorithm to find out if there are anomalies present in the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run Seasonal-Hybrid ESD for nitrate concentrations</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">AnomalyDetectionVec</span>(river<span class="sc">$</span>nitrate,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">period =</span> <span class="dv">12</span>, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">direction =</span> <span class="st">'both'</span>, </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">plot =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="interpreting-seasonal-hybrid-esd-output" class="level3">
<h3 class="anchored" data-anchor-id="interpreting-seasonal-hybrid-esd-output">Interpreting Seasonal-Hybrid ESD output</h3>
<p>The Seasonal-Hybrid ESD algorithm provides some useful output for understanding where the anomalies occur within the data.</p>
<p>In particular, the AnomalyDetectionVec() function generates output as a list with the two elements</p>
<p>$anoms, a data frame containing the columns index and anoms $plot a plot of the time series with anomalies highlighted (if plot = T)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Seasonal-Hybrid ESD for nitrate concentrations</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>river_anomalies <span class="ot">&lt;-</span> <span class="fu">AnomalyDetectionVec</span>(<span class="at">x =</span> river<span class="sc">$</span>nitrate, <span class="at">period =</span> <span class="dv">12</span>, <span class="at">direction =</span> <span class="st">'both'</span>, <span class="at">plot =</span> T)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the anomalies</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>river_anomalies<span class="sc">$</span>anoms</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the plot</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(river_anomalies<span class="sc">$</span>plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="seasonal-hybrid-esd-versus-grubbs-test" class="level4">
<h4 class="anchored" data-anchor-id="seasonal-hybrid-esd-versus-grubbs-test">Seasonal-Hybrid ESD versus Grubbs’ test</h4>
<p>Recall when using Grubbs’ test on the river nitrate data, that only row 156 was found to be anomalous, while Seasonal-Hybrid ESD identified 2 further high-valued anomalies. Which of the following provides the best explanation for the difference between the two approaches?</p>
<ul>
<li><em>Spot on! Grubbs’ test can only take an extreme value as a candidate for an outlier, while Seasonal-Hybrid ESD explicitly accounts for the repeating seasonal patterns. Therefore, it is likely that the extra anomalies have been identified as extreme with respect to the seasonal pattern in the data.</em></li>
</ul>
</section>
</section>
</section>
<section id="distance-and-density-based-anomaly-detection" class="level2">
<h2 class="anchored" data-anchor-id="distance-and-density-based-anomaly-detection">Distance and density based anomaly detection</h2>
<section id="exploring-wine" class="level3">
<h3 class="anchored" data-anchor-id="exploring-wine">Exploring wine</h3>
<p>Throughout this chapter, you’ll explore techniques for anomaly detection with a new data set called wine. Each row of this data set refers to a wine whose chemical composition is described by two numeric fields:</p>
<p>pH: how acidic the wine is alcohol: the wine’s alcohol content (%)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>wine <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"data/wine.csv"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>wine <span class="ot">&lt;-</span> wine[, .(pH, alcohol)]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># View the contents of the wine data</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(wine)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot of wine pH against alcohol</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pH <span class="sc">~</span> alcohol, <span class="at">data =</span> wine)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="knn-distance-matrix" class="level3">
<h3 class="anchored" data-anchor-id="knn-distance-matrix">kNN distance matrix</h3>
<p>The kNN distance matrix is a necessary prior step to producing the kNN distance score. The distance matrix has</p>
<p>rows, where is the number of data points columns, where is the user-chosen number of neighbors. The entry in row i and column j of the distance matrix is the distance between point i and its jth nearest neighbor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the 5 nearest neighbors distance</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>wine_nn <span class="ot">&lt;-</span> <span class="fu">get.knn</span>(wine, <span class="at">k =</span> <span class="dv">5</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># View the distance matrix</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(wine_nn<span class="sc">$</span>nn.dist)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance from wine 5 to nearest neighbor</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>wine_nn<span class="sc">$</span>nn.dist[<span class="dv">5</span>, <span class="dv">1</span>]</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Row index of wine 5's nearest neighbor </span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>row_idx <span class="ot">=</span> wine_nn<span class="sc">$</span>nn.ind[<span class="dv">5</span>, <span class="dv">1</span>]</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>row_idx</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Return data for wine 5 and its nearest neighbor</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>wine[<span class="fu">c</span>(<span class="dv">5</span>, row_idx), ] <span class="sc">%&gt;%</span> <span class="fu">data_table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="knn-distance-score" class="level3">
<h3 class="anchored" data-anchor-id="knn-distance-score">kNN distance score</h3>
<p>Once the kNN distance matrix is available, the nearest neighbor distance score can be calculated by averaging the nearest neighbor distances for each point.</p>
<p>Large values of the distance score can be interpreted as indicating the presence of unusual or anomalous points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the 5 nearest neighbors distance</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>wine_nn <span class="ot">&lt;-</span> <span class="fu">get.knn</span>(wine, <span class="at">k =</span> <span class="dv">5</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create score by averaging distances</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>wine_nnd <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(wine_nn<span class="sc">$</span>nn.dist)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(wine_nnd)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print row index of the most anomalous point</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="fu">which.max</span>(wine_nnd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="standardizing-features" class="level3">
<h3 class="anchored" data-anchor-id="standardizing-features">Standardizing features</h3>
<p>It is important to ensure that the feature inputs to the kNN distance calculation are standardized using the scale() function. Standardization ensures that features with large mean or variance do not disproportionately influence the kNN distance score.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Without standardization, features have different scales</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wine)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize the wine columns</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>wine_scaled <span class="ot">&lt;-</span> <span class="fu">scale</span>(wine)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardized features have similar means and quartiles</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wine_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="appending-the-knn-score" class="level3">
<h3 class="anchored" data-anchor-id="appending-the-knn-score">Appending the kNN score</h3>
<p>Now you’ve standardized your input features, it’s time to create the kNN distance score for the standardized wine data and append it as a new column.</p>
<p>In this exercise, the 5 nearest neighbor distance score is already available in the object wine_nnd. So that the score is easily available for visualization or further analysis, you’ll append the score as a new column to the unstandardized data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the 5 nearest neighbors distance</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>wine_nn <span class="ot">&lt;-</span> <span class="fu">get.knn</span>(wine_scaled, <span class="at">k =</span> <span class="dv">5</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create score by averaging distances</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>wine_nnd <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(wine_nn<span class="sc">$</span>nn.dist)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the 5-nearest neighbor distance score</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>wine_nnd[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Append the score as a new column </span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>wine<span class="sc">$</span>score <span class="ot">&lt;-</span> wine_nnd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualizing-knn-distance-score" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-knn-distance-score">Visualizing kNN distance score</h3>
<p>The kNN distance score can be hard to interpret by simply eyeballing a set of values. It’s helpful to use scatterplots to visualize the kNN distance score to understand how the score works. When interpreting the plot, the relative size of the kNN distance score is more informative than the absolute value.</p>
<p>The wine data has been loaded with the kNN distance score appended from the previous exercise.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot showing pH, alcohol and kNN score</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pH <span class="sc">~</span> alcohol, <span class="at">data =</span> wine, <span class="at">cex =</span> <span class="fu">sqrt</span>(score), <span class="at">pch =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="lof-calculation" class="level3">
<h3 class="anchored" data-anchor-id="lof-calculation">LOF calculation</h3>
<p>kNN is useful for finding global anomalies, but is less able to surface local outliers. In this exercise, you’ll practice using the lof() function to calculate local outlier factors for the wine data.</p>
<p>lof() has the arguments:</p>
<p>x: the data for scoring, k: the number of neighbors used to calculate the LOF.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dbscan)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the LOF for wine data</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>wine_lof <span class="ot">&lt;-</span> <span class="fu">lof</span>(<span class="fu">scale</span>(wine), <span class="dv">5</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Append the LOF score as a new column</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>wine<span class="sc">$</span>score <span class="ot">&lt;-</span> wine_lof</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="lof-visualization" class="level3">
<h3 class="anchored" data-anchor-id="lof-visualization">LOF visualization</h3>
<p>As with kNN distance scoring, a scatterplot can be a useful visual aid for understanding why a low or high score has been assigned. In this exercise, the LOF score is visualized by scaling the points according to the size of the score. You should notice some differences in the location of points with highest scores compared to kNN distance.</p>
<p>The wine data for this exercise already contains the score column appended in the previous exercise.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot showing pH, alcohol and LOF score</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pH <span class="sc">~</span> alcohol, <span class="at">data =</span> wine, <span class="at">pch =</span> <span class="dv">20</span>, <span class="at">cex =</span> <span class="fu">sqrt</span>(score))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="lof-vs-knn" class="level3">
<h3 class="anchored" data-anchor-id="lof-vs-knn">LOF vs kNN</h3>
<p>It is common to look first at the points with highest anomaly scores before taking any action. When several algorithms are used, the points with highest scores may differ.</p>
<p>In this final exercise, you’ll calculate new LOF and kNN distance scores for the wine data, and print the highest scoring point for each.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scaled wine data</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">#wine_scaled &lt;- scale(wine)</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and append kNN distance as a new column</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>wine_nn <span class="ot">&lt;-</span> <span class="fu">get.knn</span>(wine_scaled, <span class="at">k =</span> <span class="dv">10</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>wine<span class="sc">$</span>score_knn <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(wine_nn<span class="sc">$</span>nn.dist)     </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and append LOF as a new column</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>wine<span class="sc">$</span>score_lof <span class="ot">&lt;-</span> <span class="fu">lof</span>(wine_scaled, <span class="at">k =</span> <span class="dv">10</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the row location of highest kNN</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="fu">which.max</span>(wine<span class="sc">$</span>score_knn)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the row location of highest LOF</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="fu">which.max</span>(wine<span class="sc">$</span>score_lof)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="isolation-forest" class="level2">
<h2 class="anchored" data-anchor-id="isolation-forest">Isolation forest</h2>
<section id="fit-and-predict-with-an-isolation-tree" class="level3">
<h3 class="anchored" data-anchor-id="fit-and-predict-with-an-isolation-tree">Fit and predict with an isolation tree</h3>
<p>The two most important functions to know when fitting an isolation tree are iForest() to fit and predict() to generate an isolation score. In this exercise, you’ll use these two functions to explore isolated points in the wine data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(isofor)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build an isolation tree </span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>wine_tree <span class="ot">&lt;-</span> <span class="fu">iForest</span>(wine_scaled, <span class="at">nt =</span> <span class="dv">1</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create isolation score</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>wine<span class="sc">$</span>tree_score <span class="ot">&lt;-</span> <span class="fu">predict</span>(wine_tree, <span class="at">newdata =</span> wine_scaled) </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram plot of the scores</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(wine<span class="sc">$</span>tree_score, <span class="at">breaks =</span> <span class="dv">40</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Isolation forest scores are values between 0 and 1. High scores near to 1 indicate possible anomalies, while scores between 0 and 0.5 do not.</li>
</ul>
</section>
<section id="fit-an-isolation-forest" class="level3">
<h3 class="anchored" data-anchor-id="fit-an-isolation-forest">Fit an isolation forest</h3>
<p>An isolation forest is a collection of isolation trees, and uses exactly the same commands that you used in the previous lesson to grow a single isolation tree. In this exercise, you’ll practice fitting an isolation forest to the wine data.</p>
<p>When growing an isolation forest you should to pay particular attention to the number of trees and the number of points sampled to grow each tree.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit isolation forest</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>wine_forest <span class="ot">&lt;-</span> <span class="fu">iForest</span>(wine, <span class="at">nt =</span> <span class="dv">100</span>, <span class="at">phi =</span> <span class="dv">200</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create isolation score from forest</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>wine_score <span class="ot">&lt;-</span> <span class="fu">predict</span>(wine_forest, <span class="at">newdata =</span> wine)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Append score to the wine data</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>wine<span class="sc">$</span>score <span class="ot">&lt;-</span> wine_score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="checking-convergence" class="level3">
<h3 class="anchored" data-anchor-id="checking-convergence">Checking convergence</h3>
<p>The anomaly score from an isolation forest usually don’t change after a certain number of trees have been grown. This is called convergence, and can be checked by comparing the scores generated by forests with different numbers of trees. If the scores differ greatly, then this might suggest that more trees are required.</p>
<p>In this exercise, the scores for isolation forests with different numbers of trees have been already calculated for you and are contained in the data frame wine_scores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>wine <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"data/wine.csv"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>wine <span class="ot">&lt;-</span> wine[, .(pH, alcohol)]</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># View the contents of the wine scores</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit isolation forest</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>wine_forest_2000 <span class="ot">&lt;-</span> <span class="fu">iForest</span>(wine, <span class="at">nt =</span> <span class="dv">200</span>, <span class="at">phi =</span> <span class="dv">200</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>trees_2000 <span class="ot">&lt;-</span> <span class="fu">predict</span>(wine_forest_2000, <span class="at">newdata =</span> wine)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>wine_forest_1000 <span class="ot">&lt;-</span> <span class="fu">iForest</span>(wine, <span class="at">nt =</span> <span class="dv">100</span>, <span class="at">phi =</span> <span class="dv">200</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>trees_1000 <span class="ot">&lt;-</span> <span class="fu">predict</span>(wine_forest_1000, <span class="at">newdata =</span> wine)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>wine_scores <span class="ot">&lt;-</span>  <span class="fu">data.frame</span>(trees_2000,  trees_1000)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(wine_scores)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Score scatterplot 2000 vs 1000 trees </span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(trees_2000 <span class="sc">~</span> trees_1000, <span class="at">data =</span> wine_scores)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Add reference line of equality</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-grid-of-points" class="level3">
<h3 class="anchored" data-anchor-id="a-grid-of-points">A grid of points</h3>
<p>In the video, you saw how it can be instructive to use a contour plot over a grid of points to see what the anomaly score might have been at locations other than where the data occurred.</p>
<p>In this exercise you’ll create and visualize a grid of points across the region of interest. The grid you create will be used in the exercise that follows to visualize predicted isolation scores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sequence of values for pH and alcohol</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>ph_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(wine<span class="sc">$</span>pH), <span class="fu">max</span>(wine<span class="sc">$</span>pH), <span class="at">length.out =</span> <span class="dv">25</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>alcohol_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(wine<span class="sc">$</span>alcohol),  <span class="fu">max</span>(wine<span class="sc">$</span>alcohol), <span class="at">length.out =</span> <span class="dv">25</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data frame of grid coordinates</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>wine_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">pH =</span> ph_seq, <span class="at">alcohol =</span> alcohol_seq)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualise the grid using a scatterplot</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pH<span class="sc">~</span>alcohol, <span class="at">data =</span> wine_grid, <span class="at">pch =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prediction-over-a-grid" class="level3">
<h3 class="anchored" data-anchor-id="prediction-over-a-grid">Prediction over a grid</h3>
<p>In this exercise, you’ll use an isolation forest to obtain an anomaly score for the grid of points you created in the last exercise. Getting the anomaly score is the final preparatory step required to visualize the isolation scores.</p>
<p>The data frame wine_grid and fitted isolation forest wine_forest from the previous exercise are preloaded.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate isolation score at grid locations</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>wine_grid<span class="sc">$</span>score <span class="ot">&lt;-</span> <span class="fu">predict</span>(wine_forest_2000, wine_grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="anomaly-contours" class="level3">
<h3 class="anchored" data-anchor-id="anomaly-contours">Anomaly contours</h3>
<p>You now have the key ingredients to produce a contour plot, which is a powerful tool for viewing how the anomaly score varies across the region spanned by the data points.</p>
<p>The wine_grid data from the previous exercise has been preloaded for you to use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lattice)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Contour plot of isolation scores</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">contourplot</span>(score <span class="sc">~</span> pH <span class="sc">+</span> alcohol, wine_grid, <span class="at">region =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="comparing-performance" class="level2">
<h2 class="anchored" data-anchor-id="comparing-performance">Comparing performance</h2>
<section id="thyroid-data" class="level3">
<h3 class="anchored" data-anchor-id="thyroid-data">Thyroid data</h3>
<p>In this chapter, you’ll explore a new data set called thyroid. These data contain examples of thyroid hormone measurements for 1000 patients, and a column called label indicating the presence of thyroid disease. It is expected that unusual hormone measurements can be used to detect disease.</p>
<p>The overall goal is to determine whether an anomaly score based on hormone measurements could be used to detect thyroid disease. In this exercise, you’ll use plotting techniques to visually assess the distribution of thyroid disease.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>thyroid <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"data/thyroid.csv"</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># View contents of thryoid data</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(thyroid)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabulate the labels</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(thyroid<span class="sc">$</span>label)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Proportion of thyroid cases</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>prop_disease <span class="ot">&lt;-</span> <span class="dv">22</span><span class="sc">/</span>(<span class="dv">978</span><span class="sc">+</span><span class="dv">22</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualizing-thyroid-disease" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-thyroid-disease">Visualizing thyroid disease</h3>
<p>In previous chapters, we considered data with two or fewer features. As the number of features increases, it becomes harder to visually assess whether individual points are anomalous.</p>
<p>In cases where anomaly labels are available, it is important to use scatterplots to visualize how the distribution of anomalies varies with different combinations of features.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot showing TT4, TBG and anomaly labels</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(TT4 <span class="sc">~</span> TBG, <span class="at">data =</span> thyroid, <span class="at">pch =</span> <span class="dv">20</span>, <span class="at">col =</span> label <span class="sc">+</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><em>The disease cases seem to occur at extreme values of the hormone measurements. Next you’ll build an anomaly score to capture this!</em></li>
</ul>
</section>
<section id="anomaly-score" class="level3">
<h3 class="anchored" data-anchor-id="anomaly-score">Anomaly score</h3>
<p>Your visualization suggested that thyroid disease could be detected from anomalous hormone measurements.</p>
<p>In this exercise you’ll use an isolation forest to generate an anomaly score for thyroid levels, and compare the resulting score against the true disease status.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit isolation forest</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>thyroid_xdf <span class="ot">&lt;-</span> thyroid[, .SD, .SDcols <span class="ot">=</span> <span class="sc">!</span><span class="st">"label"</span>]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>thyroid_forest <span class="ot">&lt;-</span> <span class="fu">iForest</span>(thyroid[, .SD, <span class="at">.SDcols =</span> <span class="sc">!</span><span class="st">"label"</span>], <span class="at">nt =</span> <span class="dv">200</span>, <span class="at">phi =</span> <span class="dv">100</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Anomaly score </span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>thyroid<span class="sc">$</span>iso_score <span class="ot">&lt;-</span> <span class="fu">predict</span>(thyroid_forest, thyroid[, <span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Boxplot of the anomaly score against labels</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(iso_score <span class="sc">~</span> label, <span class="at">data =</span> thyroid, <span class="at">col =</span> <span class="st">"olivedrab4"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><em>The boxplot showed that the anomaly scores were generally higher for the thyroid disease cases. This adds further weight to the claim that the disease cases could be detected from anomalous hormone levels.</em></li>
</ul>
</section>
<section id="binarized-scores" class="level3">
<h3 class="anchored" data-anchor-id="binarized-scores">Binarized scores</h3>
<p>It’s worthwhile to compare the performance of more than one anomaly detection algorithm before deciding which to use.</p>
<p>In this exercise, you’ll construct a pair of binary anomaly scores based on local outlier factor (LOF) and the isolation forest. The isolation score vector iso_score generated in the previous exercise is preloaded for you to use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>iso_score <span class="ot">&lt;-</span> thyroid<span class="sc">$</span>iso_score</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale the measurement columns of thyroid</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>scaled_thyroid_measurements <span class="ot">&lt;-</span> <span class="fu">scale</span>(thyroid_xdf)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a LOF score for the measurements</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>lof_score <span class="ot">&lt;-</span> <span class="fu">lof</span>(scaled_thyroid_measurements, <span class="at">k =</span> <span class="dv">10</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate high threshold for lof_score</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>high_lof <span class="ot">&lt;-</span> <span class="fu">quantile</span>(lof_score, <span class="at">probs =</span> <span class="fl">0.98</span>) </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Append binary LOF score to thyroid data</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>thyroid<span class="sc">$</span>binary_lof <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(lof_score <span class="sc">&gt;=</span> high_lof)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate high threshold for iso_score</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>high_iso <span class="ot">&lt;-</span> <span class="fu">quantile</span>(iso_score, <span class="at">probs =</span> <span class="fl">0.98</span>)  </span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Append binary isolation score to thyroid data</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>thyroid<span class="sc">$</span>binary_iso <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(iso_score<span class="sc">&gt;</span> high_iso )         </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><em>Although the 98th percentile was chosen here, other thresholds could have been used. The choice might be constrained by the number of potential anomalies you have time to check, or the cost of missing an anomaly.</em></li>
</ul>
</section>
<section id="cross-tabulate-binary-scores" class="level3">
<h3 class="anchored" data-anchor-id="cross-tabulate-binary-scores">Cross-tabulate binary scores</h3>
<p>The table() function tallies the number of occurrences of combinations of values across one or more vectors. The orientation of the output table depends on the order that the input vectors are specified. For example in the table</p>
<p>table(currency, country)</p>
<pre><code>    country</code></pre>
<p>currency UK USA $ 0 1 £ 1 0 the rows are indexed by currency because this appears first in the table() function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabulate agreement of label and binary isolation score </span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(thyroid<span class="sc">$</span>label, thyroid<span class="sc">$</span>binary_iso)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabulate agreement of label and binary LOF score </span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(thyroid<span class="sc">$</span>label, thyroid<span class="sc">$</span>binary_lof)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Proportion of binary_iso and label that agree</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>iso_prop <span class="ot">&lt;-</span> <span class="fu">mean</span>(thyroid<span class="sc">$</span>label <span class="sc">==</span> thyroid<span class="sc">$</span>binary_iso)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Proportion of binary_lof and label that agree</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>lof_prop <span class="ot">&lt;-</span> <span class="fu">mean</span>(thyroid<span class="sc">$</span>label <span class="sc">==</span> thyroid<span class="sc">$</span>binary_lof)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><em>Although the measure of agreement is intuitive, it can be misleadingly high when anomalies are very rare. In the next exercise, you’ll try other ways to quantify the success of the algorithm.</em></li>
</ul>
</section>
<section id="thyroid-precision-and-recall" class="level3">
<h3 class="anchored" data-anchor-id="thyroid-precision-and-recall">Thyroid precision and recall</h3>
<p>Cross-tabulating the agreement between a binary score and a known label is a great way to understand how well the algorithm performs. Precision and recall are two further measures based on the table that give more insight into how well the score performs.</p>
<p>In this exercise, you’ll explore precision and recall using the thyroid data. The binary_lof and binary_iso scores created in the previous exercises are available to use as columns in the thyroid data. The code used to tabulate agreements in the previous exercise is also included.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabulation for the binary isolation score</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(thyroid<span class="sc">$</span>label, thyroid<span class="sc">$</span>binary_iso)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Precision for the isolation score</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>precision_iso <span class="ot">&lt;-</span> <span class="dv">12</span> <span class="sc">/</span> (<span class="dv">8</span> <span class="sc">+</span> <span class="dv">12</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Recall for the isolation score</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>recall_iso <span class="ot">&lt;-</span> <span class="dv">12</span> <span class="sc">/</span> (<span class="dv">10</span><span class="sc">+</span><span class="dv">12</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabulation for the binary lof score</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(thyroid<span class="sc">$</span>label, thyroid<span class="sc">$</span>binary_lof)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Precision for the binary lof score</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>precision_lof <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="sc">/</span> (<span class="dv">20</span> <span class="sc">+</span> <span class="dv">0</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Recall for the binary lof score</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>recall_lof <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="sc">/</span> (<span class="dv">22</span><span class="sc">+</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="converting-character-to-factor" class="level3">
<h3 class="anchored" data-anchor-id="converting-character-to-factor">Converting character to factor</h3>
<p>Both LOF and isolation forest can be trained using data containing categorical features, but it’s easier if these are converted to factors first.</p>
<p>In this exercise, you’ll revisit the thyroid data which contains some additional categorical features that will need to be converted.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the column classes in thyroid</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(<span class="at">X =</span> thyroid, <span class="at">FUN =</span> class)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert column with character class to factor</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>thyroid<span class="sc">$</span>age <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(thyroid<span class="sc">$</span>age)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>thyroid<span class="sc">$</span>sex <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(thyroid<span class="sc">$</span>sex)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that all columns are factor or numeric</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(<span class="at">X =</span> thyroid, <span class="at">FUN =</span> class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="isolation-forest-with-factors" class="level3">
<h3 class="anchored" data-anchor-id="isolation-forest-with-factors">Isolation forest with factors</h3>
<p>As you saw in the video, an isolation forest can accept categorical features as input, but only if they are encoded as factor variables.</p>
<p>In this exercise, the thyroid data you edited in the previous exercise is preloaded. To be extra careful, you should first check that all of the features are numeric or factor before attempting to train an isolation forest.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the class of age column</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(thyroid<span class="sc">$</span>age)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the class of sex column</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(thyroid<span class="sc">$</span>sex)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit an isolation forest with 100 trees</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>thyroid_for <span class="ot">&lt;-</span> <span class="fu">iForest</span>(thyroid[,<span class="sc">-</span><span class="dv">1</span>], <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><em>Being able to incorporate categorical features greatly extends the range of applications in which isolation forests can be used.</em></li>
</ul>
</section>
<section id="lof-with-factors" class="level3">
<h3 class="anchored" data-anchor-id="lof-with-factors">LOF with factors</h3>
<p>The lof() function can accept either a numeric data frame or a distance matrix as input to calculate LOF scores. In this exercise, you’ll practice calculating a distance matrix using Gower’s distance, which can then be passed to the lof() function for scoring.</p>
<p>As in the previous exercise, the thyroid data with character columns converted to factors has been preloaded for you to use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Gower's distance matrix</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cluster)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>thyroid_dist <span class="ot">&lt;-</span> <span class="fu">daisy</span>(thyroid[, <span class="sc">-</span><span class="dv">1</span>], <span class="at">metric =</span> <span class="st">"gower"</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate LOF scores for thyroid data</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>thyroid_lof <span class="ot">&lt;-</span> <span class="fu">lof</span>(thyroid_dist, <span class="at">k =</span> <span class="dv">10</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Range of values in the distance matrix</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(<span class="fu">as.matrix</span>(thyroid_dist))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>