---
title: "MNIST Digits"
author: "Mburu"
date: "7/10/2020"
output:
  html_document:
    theme: united
    highlight: pygments
    df_print: paged
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```



### Read data and Load libraries

```{r }

library(tidyverse)
library(data.table)
library(keras)
library(caret)
library(DT)

train_data <- fread("data/train.csv")

test_data <- fread("data/test.csv")

```

### Frequency of digits

```{r}
ggplot(train_data, aes(x = factor(label))) +
    geom_bar()
```


### Randomly sample 10 digits

```{r}
#  image coordinates
xy_axis <- data.frame(x = expand.grid(1:28, 28:1)[,1],
                      y = expand.grid(1:28, 28:1)[,2])


# get 10 images
sample_10 <- train_data[sample(1:.N, 12), -1] %>% as.matrix()

datatable(sample_10, 
          options = list(scrollX = TRUE))

sample_10 <- t(sample_10)

plot_data <- cbind(xy_axis, sample_10 )

setDT(plot_data, keep.rownames = "pixel")

# Observe the first records
head(plot_data) %>% datatable()
```

### Plot the 12 digits

````{r}
plot_data_m <- melt(plot_data, id.vars = c("pixel", "x", "y"))

# Plot the image using ggplot()
ggplot(plot_data_m, aes(x, y, fill = value)) +
    geom_raster()+
     facet_wrap(~variable)+
    scale_fill_gradient(low = "white",
                        high = "black", guide = FALSE)+
    theme(axis.line = element_blank(),
                  axis.text = element_blank(),
                  axis.ticks = element_blank(),
                  axis.title = element_blank(),
                  panel.background = element_blank(),
                  panel.border = element_blank(),
                  panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),
                  plot.background = element_blank())
   
```

### Prepare data for model fitting

```{r }
N = nrow(train_data)
sample_train <- sample(N, size = round(0.8 *N ))
train_y <-to_categorical(train_data$label, 10)

train_x <- train_data[, -1]
#convert to matrix
train_x <- train_x %>%
    as.matrix()

train_x <- train_x/255

```


### Construct model layers

```{r }
model <- keras_model_sequential() 
model %>% 
    layer_dense(units = 784, activation = 'relu', input_shape = 784) %>%
    layer_dropout(rate = 0.3) %>%
    layer_dense(units = 784, activation = 'relu') %>%
    layer_dropout(rate = 0.3) %>%
    layer_dense(units = 392, activation = 'sigmoid') %>%
    layer_dropout(rate = 0.2) %>%
    #layer_dense(units = 200, activation = 'relu') %>%
    #layer_dropout(rate = 0.) %>%
    layer_dense(units = 10, activation = 'softmax')
```


### Compile model

```{r }
model %>% compile(
    loss = 'categorical_crossentropy',
    optimizer = 'adam',
    metrics = c('accuracy'))
```

### Fit model

```{r, message=TRUE}
hist <- model %>% fit(train_x, train_y, 
                      epochs = 9, batch_size = 1000,
                      validation_split = .2)


plot(hist,type = "b")
```

### Save predictions

```{r }
test_x <- as.matrix(test_data)/255

test_pred <- model %>% predict_classes(test_x)
#head(test_pred)

df_pred1 <- data.frame(ImageId = 1:length(test_pred),
                       Label = test_pred)

write.csv(df_pred1, file = "sample_submission.csv", row.names = F)

```


##